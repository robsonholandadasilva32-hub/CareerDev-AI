{% extends "base.html" %}

{% block content %}
<div class="auth-container">
    <div class="card auth-card" style="max-width: 600px; margin: 0 auto; padding: 30px;">
        <h2 style="text-align: center; color: #00f3ff;">{{ t.billing_title | default('Assinatura e Cobrança') }}</h2>

        <p style="text-align: center; margin-bottom: 20px;">
            {{ t.billing_desc | default('Para continuar evoluindo sua carreira, ative sua assinatura.') }}
        </p>

        {% if error %}
        <div style="background-color: rgba(255, 0, 85, 0.2); color: #ff0055; padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: center;">
            {{ error }}
        </div>
        {% endif %}

        <div class="plan-info" style="text-align: center; margin-bottom: 30px; background: rgba(0, 243, 255, 0.05); padding: 20px; border-radius: 8px;">
            <h3 style="font-size: 2em; margin: 0;">$1.00 <span style="font-size: 0.5em; color: #9ca3af;">/ {{ t.month | default('mês') }}</span></h3>
            <ul style="list-style: none; padding: 0; margin-top: 15px; text-align: left; display: inline-block;">
                <li>✅ {{ t.billing_benefit_1 | default('Acesso total ao Dashboard') }}</li>
                <li>✅ {{ t.billing_benefit_2 | default('Análise de Carreira com IA') }}</li>
                <li>✅ {{ t.billing_benefit_3 | default('Suporte Prioritário') }}</li>
            </ul>
        </div>

        <form action="/billing/pay" method="POST" id="payment-form">
            <!-- Recurring Toggle -->
            <div style="margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <label for="recurring" style="cursor: pointer;">{{ t.billing_recurring_label | default('Cobrança Recorrente (Assinatura)') }}</label>
                <input type="checkbox" id="recurring" name="recurring" checked style="width: 20px; height: 20px; accent-color: #00f3ff;">
            </div>

            <div class="form-group">
                <label for="card-element">Cartão de Crédito ou Débito</label>
                <div id="card-element" style="padding: 15px; background: #374151; border-radius: 5px;">
                    <!-- A Stripe Element will be inserted here. -->
                </div>
                <!-- Used to display form errors. -->
                <div id="card-errors" role="alert" style="color: #ff0055; margin-top: 10px;"></div>
            </div>

            <button type="submit" class="btn-primary" style="width: 100%; margin-top: 20px;">
                {{ t.billing_pay_button | default('Pagar $1.00') }}
            </button>
        </form>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    // Create a Stripe client.
    var stripe = Stripe('{{ stripe_pk }}');

    // Create an instance of Elements.
    var elements = stripe.elements();

    // Custom styling can be passed to options when creating an Element.
    var style = {
        base: {
            color: '#e5e7eb',
            fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
            fontSmoothing: 'antialiased',
            fontSize: '16px',
            '::placeholder': {
                color: '#9ca3af'
            }
        },
        invalid: {
            color: '#ff0055',
            iconColor: '#ff0055'
        }
    };

    // Create an instance of the card Element.
    var card = elements.create('card', {style: style});

    // Add an instance of the card Element into the `card-element` <div>.
    card.mount('#card-element');

    // Handle real-time validation errors from the card Element.
    card.on('change', function(event) {
        var displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });

    // Handle form submission.
    var form = document.getElementById('payment-form');
    form.addEventListener('submit', function(event) {
        event.preventDefault();

        stripe.createToken(card).then(function(result) {
            if (result.error) {
                // Inform the user if there was an error.
                var errorElement = document.getElementById('card-errors');
                errorElement.textContent = result.error.message;
            } else {
                // Send the token to your server.
                stripeTokenHandler(result.token);
            }
        });
    });

    // Submit the form with the token ID.
    function stripeTokenHandler(token) {
        // Insert the token ID into the form so it gets submitted to the server
        var form = document.getElementById('payment-form');
        var hiddenInput = document.createElement('input');
        hiddenInput.setAttribute('type', 'hidden');
        hiddenInput.setAttribute('name', 'stripeToken');
        hiddenInput.setAttribute('value', token.id);
        form.appendChild(hiddenInput);

        // Submit the form
        form.submit();
    }
</script>
{% endblock %}
