{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
<div class="card accessibility-page">
    <div class="a11y-panel-container" style="background: transparent; border: none; padding: 0;">

        <!-- HEADER -->
        <div style="margin-bottom: 25px; border-bottom: 2px solid var(--accent-color); padding-bottom: 15px;">
            <h2 style="display: flex; align-items: center; gap: 10px; color: var(--primary-color);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                Universal Accessibility
            </h2>
            <p style="color: var(--text-muted); font-size: 0.95rem;">
                Customize your experience. Settings saved automatically.
            </p>
        </div>

        <!-- SECTION 1: COGNITIVE & READING -->
        <section class="a11y-section" aria-labelledby="sec-cognitive">
            <h3 id="sec-cognitive" class="section-title">
                <span class="icon">üß†</span> Cognitive & Reading
            </h3>
            <div class="grid-options">
                <!-- Dyslexia Font -->
                <div class="a11y-toggle">
                    <label class="switch-label">
                        <span>Dyslexia Font (OpenDyslexic)</span>
                        <input type="checkbox" id="a11y-font" onchange="toggleA11y('dyslexic-font')">
                        <span class="slider"></span>
                    </label>
                </div>
                <!-- Reading Guide -->
                <div class="a11y-toggle">
                    <label class="switch-label">
                        <span>Reading Guide (Focus)</span>
                        <input type="checkbox" id="a11y-guide" onchange="toggleReadingGuide()">
                        <span class="slider"></span>
                    </label>
                </div>
                <!-- Stop Animations -->
                <div class="a11y-toggle">
                    <label class="switch-label">
                        <span>Stop Animations (ADHD/Vestibular)</span>
                        <input type="checkbox" id="a11y-motion" onchange="toggleA11y('reduced-motion')">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </section>

        <!-- SECTION 2: VISION & DISPLAY -->
        <section class="a11y-section" aria-labelledby="sec-vision">
            <h3 id="sec-vision" class="section-title">
                <span class="icon">üëÅÔ∏è</span> Vision & Colors
            </h3>
            <div class="grid-options">
                <!-- High Contrast -->
                <div class="a11y-toggle">
                    <label class="switch-label">
                        <span>High Contrast</span>
                        <input type="checkbox" id="a11y-contrast" onchange="toggleA11y('high-contrast')">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- Color Blindness Select -->
                <div class="a11y-control">
                    <label for="color-filter">Color Blindness Filter</label>
                    <select id="color-filter" onchange="applyColorFilter(this.value)" class="a11y-select">
                        <option value="none">None</option>
                        <option value="protanopia">Protanopia (Red)</option>
                        <option value="deuteranopia">Deuteranopia (Green)</option>
                        <option value="tritanopia">Tritanopia (Blue)</option>
                        <option value="achromatopsia">Achromatopsia (Monochrome)</option>
                    </select>
                </div>

                <!-- Font Size -->
                <div class="a11y-control full-width">
                    <label for="font-size-range">Text Size</label>
                    <div class="range-wrapper">
                        <span style="font-size: 0.8rem">A</span>
                        <input type="range" id="font-size-range" min="100" max="150" step="10" value="100" oninput="updateFontSize(this.value)">
                        <span style="font-size: 1.2rem">A</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 3: HEARING & SOUND (NEW) -->
        <section class="a11y-section" aria-labelledby="sec-hearing">
            <h3 id="sec-hearing" class="section-title">
                <span class="icon">üëÇ</span> Hearing & Sound
            </h3>
            <div class="grid-options">
                <!-- Visual Alerts -->
                <div class="a11y-toggle">
                    <label class="switch-label">
                        <span>Visual Alerts (Flash)</span>
                        <input type="checkbox" id="a11y-visual-alerts" onchange="toggleA11yState('visual-alerts')">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- Simplified Communication -->
                <div class="a11y-toggle">
                    <label class="switch-label">
                        <span>Simplified Communication (Chat)</span>
                        <input type="checkbox" id="a11y-simple-text" onchange="toggleA11yState('simple-text')">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- Libras Mode -->
                <div class="a11y-toggle">
                    <label class="switch-label">
                        <span>Libras Assistant (Brazilian Sign Language)</span>
                        <input type="checkbox" id="a11y-libras" onchange="toggleLibras()">
                        <span class="slider"></span>
                    </label>
                    <small style="display: block; margin-top: 5px; color: var(--text-muted); font-size: 0.8rem; line-height: 1.2;">
                        Activates the official Libras interpreter avatar.
                    </small>
                </div>
            </div>
        </section>

        <!-- SECTION 4: MOTOR & INTERACTION -->
        <section class="a11y-section" aria-labelledby="sec-motor">
            <h3 id="sec-motor" class="section-title">
                <span class="icon">‚úã</span> Motor & Interaction
            </h3>
            <div class="grid-options">
                <!-- Big Targets -->
                <div class="a11y-toggle">
                    <label class="switch-label">
                        <span>Expanded Click Areas</span>
                        <input type="checkbox" id="a11y-big-targets" onchange="toggleA11y('big-targets')">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- Voice Navigation -->
                <div class="a11y-toggle">
                    <label class="switch-label">
                        <span>Voice Command (Beta)</span>
                        <input type="checkbox" id="a11y-voice" onchange="toggleVoiceNav()">
                        <span class="slider"></span>
                    </label>
                    <small id="voice-status" style="display: block; margin-top: 5px; color: var(--primary-color); font-size: 0.8rem; display: none;">
                        üé§ Listening... Say "Go to Dashboard", "Logout", "Scroll Down"
                    </small>
                </div>
            </div>
        </section>

    </div>
</div>

<!-- Reading Guide Element -->
<div id="reading-guide-bar" style="display: none; position: fixed; height: 30px; width: 100%; background: rgba(255, 242, 0, 0.15); pointer-events: none; z-index: 99999; border-top: 2px solid #ffee00; border-bottom: 2px solid #ffee00; top: 0; left: 0; box-shadow: 0 0 100px rgba(0,0,0,0.5);"></div>

<!-- VLibras Widget -->
<div vw class="enabled" style="display: none;" id="vlibras-widget">
    <div vw-access-button class="active"></div>
    <div vw-plugin-wrapper>
        <div class="vw-plugin-top-wrapper"></div>
    </div>
</div>
<script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>

<style>
    /* Panel Layout */
    .a11y-section {
        margin-bottom: 30px;
        background: rgba(255,255,255,0.02);
        padding: 15px;
        border-radius: 8px;
    }
    .section-title {
        font-size: 1.1rem;
        margin-bottom: 15px;
        color: var(--text-color);
        border-left: 4px solid var(--primary-color);
        padding-left: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .section-title .icon { font-size: 1.4rem; }

    /* Grid */
    .grid-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 15px;
    }
    .full-width { grid-column: 1 / -1; }

    /* Controls */
    .switch-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.2);
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
        border: 1px solid transparent;
    }
    .switch-label:hover {
        background: rgba(0, 243, 255, 0.05);
        border-color: rgba(0, 243, 255, 0.2);
    }
    .switch-label input { display: none; }

    .slider {
        width: 44px; height: 24px; background: #374151; border-radius: 24px; position: relative; transition: 0.3s;
    }
    .slider::before {
        content: ""; position: absolute; width: 18px; height: 18px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: 0.3s;
    }
    input:checked + .slider { background: var(--secondary-color); }
    input:checked + .slider::before { transform: translateX(20px); }

    /* Select & Range */
    .a11y-control label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: #cbd5e1; }
    .a11y-select {
        width: 100%; padding: 10px; background: #0f172a; border: 1px solid #334155;
        color: white; border-radius: 6px; cursor: pointer;
    }
    .range-wrapper {
        display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;
    }
    input[type=range] { flex: 1; accent-color: var(--primary-color); cursor: pointer; }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<script>
    // --- STATE MANAGEMENT ---
    document.addEventListener("DOMContentLoaded", () => {
        // Load Class Toggles
        const toggles = ['dyslexic-font', 'high-contrast', 'reduced-motion', 'big-targets'];
        toggles.forEach(cls => {
            if (localStorage.getItem(cls) === 'true') {
                document.documentElement.classList.add(cls);
                const el = document.getElementById('a11y-' + cls);
                if(el) el.checked = true;
            }
        });

        // Load State Toggles (Non-class based)
        const stateToggles = ['visual-alerts', 'simple-text'];
        stateToggles.forEach(key => {
            if (localStorage.getItem(key) === 'true') {
                const el = document.getElementById('a11y-' + key);
                if(el) el.checked = true;
            }
        });

        // Load Libras
        if (localStorage.getItem('libras-mode') === 'true') {
            document.getElementById('a11y-libras').checked = true;
            initVLibras();
        }

        // Load Filters
        const savedFilter = localStorage.getItem('color-filter');
        if (savedFilter && savedFilter !== 'none') {
            document.documentElement.setAttribute('data-color-filter', savedFilter);
            document.getElementById('color-filter').value = savedFilter;
        }

        // Load Font Size
        const savedSize = localStorage.getItem('font-size') || 100;
        document.documentElement.style.fontSize = savedSize + '%';
        const range = document.getElementById('font-size-range');
        if(range) range.value = savedSize;
    });

    // --- CORE FUNCTIONS ---
    function toggleA11y(className) {
        document.documentElement.classList.toggle(className);
        localStorage.setItem(className, document.documentElement.classList.contains(className));
    }

    // Toggle logic for states that don't add a global CSS class but are used by JS components
    function toggleA11yState(key) {
        const el = document.getElementById('a11y-' + key);
        localStorage.setItem(key, el.checked);
    }

    let vlibrasInitialized = false;
    function initVLibras() {
        document.getElementById('vlibras-widget').style.display = 'block';
        if (!vlibrasInitialized && window.VLibras) {
            new window.VLibras.Widget('https://vlibras.gov.br/app');
            vlibrasInitialized = true;
        }
    }

    function toggleLibras() {
        const el = document.getElementById('a11y-libras');
        localStorage.setItem('libras-mode', el.checked);

        if (el.checked) {
            initVLibras();
        } else {
            document.getElementById('vlibras-widget').style.display = 'none';
        }
    }

    function applyColorFilter(filterName) {
        document.documentElement.setAttribute('data-color-filter', filterName);
        localStorage.setItem('color-filter', filterName);
    }

    function updateFontSize(val) {
        document.documentElement.style.fontSize = val + '%';
        localStorage.setItem('font-size', val);
    }

    // --- READING GUIDE ---
    let guideActive = false;
    function toggleReadingGuide() {
        guideActive = !guideActive;
        const bar = document.getElementById('reading-guide-bar');
        bar.style.display = guideActive ? 'block' : 'none';

        if (guideActive) {
            document.addEventListener('mousemove', moveGuide);
        } else {
            document.removeEventListener('mousemove', moveGuide);
        }
    }
    function moveGuide(e) {
        const bar = document.getElementById('reading-guide-bar');
        bar.style.top = (e.clientY - 15) + 'px';
    }

    // --- VOICE NAVIGATION (Web Speech API) ---
    let recognition;
    function toggleVoiceNav() {
        const statusEl = document.getElementById('voice-status');
        const checkbox = document.getElementById('a11y-voice');

        if (!checkbox.checked) {
            if (recognition) recognition.stop();
            statusEl.style.display = 'none';
            return;
        }

        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert("Your browser does not support Voice Commands. Try Chrome or Edge.");
            checkbox.checked = false;
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.continuous = true;
        recognition.interimResults = false;

        recognition.onstart = () => {
            statusEl.style.display = 'block';
            statusEl.innerText = "üé§ Listening... (Say 'Help' for commands)";
        };

        recognition.onresult = (event) => {
            const command = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
            console.log("Voice Command:", command);
            statusEl.innerText = `üé§ Heard: "${command}"`;
            handleVoiceCommand(command);
        };

        recognition.onerror = (e) => {
            console.error(e);
            statusEl.innerText = "‚ùå Error listening. Try reloading.";
        };

        recognition.start();
    }

    function handleVoiceCommand(cmd) {
        // Navigation Map
        if (cmd.includes("dashboard") || cmd.includes("home")) {
            window.location.href = "/dashboard";
        } else if (cmd.includes("config") || cmd.includes("security") || cmd.includes("settings")) {
            window.location.href = "/dashboard/security";
        } else if (cmd.includes("accessibility")) {
            window.location.href = "/dashboard/accessibility";
        } else if (cmd.includes("logout") || cmd.includes("exit")) {
            window.location.href = "/logout";
        } else if (cmd.includes("down") || cmd.includes("scroll down")) {
            window.scrollBy({ top: 400, behavior: 'smooth' });
        } else if (cmd.includes("up") || cmd.includes("scroll up")) {
            window.scrollBy({ top: -400, behavior: 'smooth' });
        } else if (cmd.includes("help")) {
            alert("Commands: 'Go to Dashboard', 'Settings', 'Accessibility', 'Logout', 'Scroll Down', 'Scroll Up'");
        }
    }
</script>
{% endblock %}
