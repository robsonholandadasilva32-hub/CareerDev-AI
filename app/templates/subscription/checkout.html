{% extends "base.html" %}

{% block content %}
<!-- STRIPE JS -->
<script src="https://js.stripe.com/v3/"></script>

<style>
    .checkout-wrapper {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 50px;
        max-width: 1200px;
        margin: 40px auto;
        align-items: center;
    }

    /* LEFT COLUMN: VISUAL & BENEFITS */
    .benefits-col {
        padding: 20px;
        animation: slideInLeft 0.8s ease-out;
    }

    .benefits-col h1 {
        font-size: 3rem;
        background: linear-gradient(135deg, #fff, #94a3b8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 20px;
        line-height: 1.1;
    }

    .benefits-list {
        list-style: none;
        padding: 0;
        margin-top: 30px;
    }

    .benefits-list li {
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 1.1rem;
        margin-bottom: 20px;
        color: #e2e8f0;
    }

    .check-icon {
        width: 24px;
        height: 24px;
        background: rgba(0, 255, 156, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--secondary-color);
        flex-shrink: 0;
    }

    .trust-badges {
        display: flex;
        gap: 20px;
        margin-top: 40px;
        opacity: 0.7;
    }

    /* RIGHT COLUMN: PAYMENT FORM */
    .payment-col {
        background: rgba(17, 24, 39, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        padding: 40px;
        border-radius: 24px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        animation: slideInRight 0.8s ease-out;
    }

    #payment-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    #submit-btn {
        background: linear-gradient(135deg, var(--primary-color), #0090cc);
        color: white;
        border: none;
        padding: 16px;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 10px;
    }

    #submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 180, 255, 0.3);
    }

    #submit-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    #error-message {
        color: var(--error-color);
        font-size: 0.9rem;
        margin-top: 10px;
        text-align: center;
    }

    /* Glassmorphism Footer Override */
    body > footer {
        background: rgba(17, 24, 39, 0.4) !important;
        backdrop-filter: blur(15px) !important;
        border-top: 1px solid rgba(255, 255, 255, 0.05) !important;
        position: relative;
        z-index: 10;
    }

    /* Responsive */
    @media (max-width: 900px) {
        .checkout-wrapper {
            grid-template-columns: 1fr;
            padding: 20px;
        }
        .benefits-col h1 { font-size: 2rem; }
    }

    @keyframes slideInLeft {
        from { opacity: 0; transform: translateX(-30px); }
        to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideInRight {
        from { opacity: 0; transform: translateX(30px); }
        to { opacity: 1; transform: translateX(0); }
    }
</style>

<div class="checkout-wrapper">
    <!-- Benefits -->
    <div class="benefits-col">
        <div style="margin-bottom: 20px;">
             <!-- Logo -->
             <svg width="50" height="50" viewBox="0 0 100 100" fill="none">
                <circle cx="50" cy="50" r="45" stroke="#00f3ff" stroke-width="5" />
                <path d="M30 50 H70 M50 30 V70" stroke="#00ff88" stroke-width="5" />
            </svg>
        </div>
        <h1>Unlock Your <br><span style="color: var(--primary-color);">Full Potential</span></h1>
        <p style="color: #94a3b8; font-size: 1.2rem;">Join elite developers accelerating their careers with AI.</p>

        <ul class="benefits-list">
            <li>
                <div class="check-icon">✓</div>
                <span>Unlimited AI Resume Analysis</span>
            </li>
            <li>
                <div class="check-icon">✓</div>
                <span>Personalized Career Roadmap</span>
            </li>
            <li>
                <div class="check-icon">✓</div>
                <span>Mock Interview Simulator</span>
            </li>
            <li>
                <div class="check-icon">✓</div>
                <span>Priority Support (VIP)</span>
            </li>
        </ul>

        <div class="trust-badges">
            <div style="display: flex; align-items: center; gap: 8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                <small>Secure Payment</small>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                <small>Encrypted</small>
            </div>
        </div>
    </div>

    <!-- Checkout Form -->
    <div class="payment-col">
        <h2 style="margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
            Subscribe Premium
            <span style="float: right; font-size: 1rem; color: var(--primary-color);">$9.99 / mo</span>
        </h2>

        {% if error %}
        <div style="padding: 20px; background: rgba(255, 0, 85, 0.1); border: 1px solid #ff0055; color: #ff0055; border-radius: 8px; text-align: center;">
            <h3>⚠️ Access Error</h3>
            <p>{{ error }}</p>
            {% if debug_error %}
            <p style="font-size: 0.8em; color: rgba(255, 0, 85, 0.7);">{{ debug_error }}</p>
            {% endif %}
        </div>
        {% else %}
        <form id="payment-form">
            <div id="payment-element">
                <!-- Stripe Elements will be inserted here -->
                {% if client_secret == 'mock_secret' %}
                <div style="padding: 20px; background: rgba(255,255,0,0.1); color: yellow; text-align: center; border-radius: 8px;">
                    Mock Mode Active (No Stripe Keys)
                </div>
                {% endif %}
            </div>

            <button id="submit-btn">Subscribe Now</button>
            <div id="error-message"></div>
        </form>
        {% endif %}

        <p style="text-align: center; margin-top: 15px; font-size: 0.8rem; color: #64748b;">
            Cancel anytime in your dashboard.
        </p>
    </div>
</div>

<script>
    {% if not error %}
    const stripe = Stripe('{{ publishable_key }}');
    const clientSecret = '{{ client_secret }}';

    // Mock Mode Handling
    if (clientSecret === 'mock_secret') {
        document.getElementById('submit-btn').addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = "/billing/success"; // Mock success
        });
    } else {
        const appearance = {
            theme: 'night',
            variables: {
                colorPrimary: '#00f3ff',
                colorBackground: '#0a0f1c',
                colorText: '#ffffff',
                colorDanger: '#ff0055',
                fontFamily: 'Inter, system-ui, sans-serif',
                spacingUnit: '4px',
                borderRadius: '8px',
            },
        };

        const elements = stripe.elements({ appearance, clientSecret });
        const paymentElement = elements.create('payment', {
            layout: 'tabs',
        });
        paymentElement.mount('#payment-element');

        const form = document.getElementById('payment-form');
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const btn = document.getElementById('submit-btn');
            const errorMsg = document.getElementById('error-message');

            btn.disabled = true;
            btn.innerText = "Processing...";
            errorMsg.innerText = "";

            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    // Make sure to use the absolute URL for return_url
                    return_url: window.location.origin + "/billing/success",
                },
            });

            if (error) {
                // Show error to your customer
                errorMsg.innerText = error.message;
                btn.disabled = false;
                btn.innerText = "Subscribe Now";
            } else {
                // Your customer will be redirected to your `return_url`.
            }
        });
    }
    {% endif %}
</script>
{% endblock %}
