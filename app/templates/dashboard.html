{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* --- 1. NUCLEAR RESET (MANDATORY) --- */
    .dashboard-sidebar, .main-header, .navbar, .footer, #sidebar-wrapper { display: none !important; }
    .content-wrapper, .main-panel, .dashboard-content {
        margin: 0 !important; padding: 0 !important; width: 100vw !important; height: 100vh !important;
        position: fixed !important; top: 0 !important; left: 0 !important; z-index: 9900 !important;
        background: #050505 !important;
    }

    /* --- 2. THEME ENGINE --- */
    :root {
        --bg-deep: #050505;
        --bg-panel: #0f111a;
        --border: rgba(255, 255, 255, 0.08);
        --neon-blue: #3b82f6;
        --neon-cyan: #06b6d4;
        --neon-green: #10b981;
        --neon-purple: #8b5cf6;
        --alert: #ef4444;
        --text-main: #f3f4f6;
        --text-dim: #9ca3af;
        --font-mono: 'JetBrains Mono', monospace;
    }

    body { background-color: var(--bg-deep) !important; color: var(--text-main); font-family: 'Inter', sans-serif; overflow: hidden; }

    /* MATRIX MODE (Easter Egg) */
    body.theme-matrix {
        background-color: #000 !important;
        font-family: 'Courier New', monospace !important;
    }
    body.theme-matrix * {
        color: #00ff00 !important;
        border-color: #00ff00 !important;
        background: #000 !important;
        font-family: 'Courier New', monospace !important;
    }

    /* --- 3. LAYOUT --- */
    .grid-layout {
        display: grid;
        grid-template-columns: 80px 1fr 350px;
        grid-template-rows: 60px 1fr 30px;
        height: 100vh; width: 100vw;
        gap: 12px; padding: 12px;
        box-sizing: border-box;
    }

    /* --- 4. PANELS --- */
    .panel {
        background: var(--bg-panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        display: flex; flex-direction: column;
        position: relative; overflow: hidden;
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.8);
    }
    .panel-head {
        padding: 12px 16px; background: rgba(255,255,255,0.02);
        border-bottom: 1px solid var(--border);
        font-family: var(--font-mono); font-size: 0.75rem; font-weight: 700;
        color: var(--neon-blue); text-transform: uppercase;
        display: flex; justify-content: space-between; align-items: center;
    }

    /* --- 5. VISUALIZATIONS --- */
    .data-row {
        display: flex; align-items: center; padding: 12px 16px;
        border-bottom: 1px solid var(--border); transition: background 0.2s;
    }
    .data-row:hover { background: rgba(255,255,255,0.03); }
    .skill-bar-track { flex-grow: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin: 0 15px; }
    .skill-bar-fill { height: 100%; border-radius: 3px; }

    /* Tag Badges */
    .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; margin-left: 5px; }
    .tag-gh { background: rgba(59, 130, 246, 0.2); color: var(--neon-blue); border: 1px solid rgba(59, 130, 246, 0.4); }
    .tag-warn { background: rgba(239, 68, 68, 0.2); color: var(--alert); border: 1px solid rgba(239, 68, 68, 0.4); }

    /* --- 6. SIDEBARS --- */
    .nav-dock { grid-row: 1 / 4; display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 20px; }
    .nav-btn {
        width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
        color: var(--text-dim); font-size: 1.4rem; cursor: pointer; text-decoration: none; transition: 0.3s;
    }
    .nav-btn:hover, .nav-btn.active { color: var(--neon-blue); background: rgba(59, 130, 246, 0.15); }

    /* --- 7. HEALTH CONTROLS --- */
    .bio-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 12px; }
    .bio-card {
        background: #000; border: 1px solid var(--border); border-radius: 6px;
        padding: 10px; text-align: center; cursor: pointer; transition: 0.2s;
    }
    .bio-card.active { border-color: var(--neon-green); background: rgba(16, 185, 129, 0.1); }
    .bio-card.active .bio-label { color: var(--neon-green); }
    .bio-label { font-size: 0.6rem; font-family: var(--font-mono); color: var(--text-dim); text-transform: uppercase; display: block; margin-top: 5px;}
    .bio-icon { font-size: 1.2rem; }

    /* --- 8. PRO SUITE BUTTONS --- */
    .btn-cyber {
        background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--neon-cyan);
        width: 100%; padding: 10px; font-family: var(--font-mono); font-size: 0.75rem; cursor: pointer;
        margin-bottom: 8px; border-radius: 4px; transition: 0.2s; text-align: left;
    }
    .btn-cyber:hover { background: rgba(6, 182, 212, 0.15); border-color: var(--neon-cyan); }

    /* --- 9. SMART LOADER --- */
    .smart-loader {
        position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9);
        display: none; justify-content: center; align-items: center; z-index: 10000; flex-direction: column;
    }
    .loader-text { font-family: var(--font-mono); color: var(--neon-green); margin-top: 20px; font-size: 0.9rem; }

    /* --- 10. TABS & STREAK --- */
    .tab-container { display: flex; gap: 10px; border-bottom: 1px solid var(--border); padding: 0 10px; margin-bottom: 0px; background: rgba(0,0,0,0.2); }
    .tab-btn {
        background: transparent; border: none; color: var(--text-dim);
        padding: 10px; font-family: var(--font-mono); font-size: 0.75rem;
        cursor: pointer; border-bottom: 2px solid transparent;
        transition: 0.3s;
    }
    .tab-btn.active { color: var(--neon-blue); border-bottom-color: var(--neon-blue); }
    .tab-btn:hover { color: #fff; }

    .streak-container { display: flex; gap: 4px; align-items: center; }
    .streak-square { width: 8px; height: 8px; border-radius: 1px; background: #333; transition: 0.3s; }
    .streak-square.active { background: var(--neon-green); box-shadow: 0 0 5px var(--neon-green); }
    .streak-square.hardcore { background: #ff4500; box-shadow: 0 0 8px #ff4500; }
</style>

<div class="smart-loader" id="global-loader">
    <div style="width: 50px; height: 50px; border: 3px solid var(--neon-green); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <div class="loader-text" id="loader-msg">INITIALIZING...</div>
    <style>@keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }</style>
</div>

<div class="grid-layout">
    
    <nav class="panel nav-dock">
        <div style="font-weight: 900; color: #fff; font-size: 1.2rem; margin-bottom: 10px;">C/AI</div>
        <a href="#" class="nav-btn active">‚åò</a>
        <a href="#" class="nav-btn">üß†</a>
        <a href="#" class="nav-btn">üåê</a>
        <div style="flex-grow: 1;"></div>
        <a href="/logout" class="nav-btn" style="color: var(--alert);">‚úï</a>
    </nav>

    <div class="panel" style="grid-column: 2/4; flex-direction: row; align-items: center; padding: 0 20px;">
        <span style="font-family: var(--font-mono); color: var(--neon-blue); margin-right: 20px;">LIVE_FEED ::</span>
        <marquee style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--neon-green);">
            GITHUB API: CONNECTED [LATENCY 12ms] /// LINKEDIN TRENDS: RUST +15%, TYPESCRIPT +8% /// SYSTEM: OPTIMAL
        </marquee>
    </div>

    <main class="panel" style="grid-column: 2/3; grid-row: 2/3;">
        <div class="panel-head">
            <span>DATA FUSION: REALITY vs MARKET</span>
            <div style="display: flex; align-items: center; gap: 15px;">
                 <div class="streak-container" id="streak-widget"></div>
                 <span style="opacity: 0.5;">{{ user.email }}</span>
            </div>
        </div>

        <div class="tab-container">
            <button class="tab-btn active" id="tab-audit" onclick="switchTab('audit')">AUDIT VIEW</button>
            <button class="tab-btn" id="tab-growth" onclick="switchTab('growth')">WEEKLY PLAN</button>
        </div>

        <div style="overflow-y: auto; flex-grow: 1; position: relative;">
            <div id="view-audit" style="display: block;"></div>
            <div id="view-growth" style="display: none; padding: 10px;"></div>
        </div>

        <div style="height: 300px; border-top: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; align-items: center;">
             <div style="width: 100%; height: 240px; position: relative;">
                <canvas id="marketRadar"></canvas>
            </div>
            <div style="margin-top: 10px; font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-dim);">
                MARKET ALIGNMENT RADAR
            </div>
        </div>
    </main>

    <aside style="grid-column: 3/4; grid-row: 2/3; display: flex; flex-direction: column; gap: 12px;">

        <div class="panel">
            <div class="panel-head">BIO_MONITOR</div>
            <div class="bio-grid">
                <div class="bio-card" onclick="toggleBio(this)"><span class="bio-icon">ü¶¥</span><span class="bio-label">Posture</span></div>
                <div class="bio-card active" onclick="toggleBio(this)"><span class="bio-icon">üëÅÔ∏è</span><span class="bio-label">Vision</span></div>
                <div class="bio-card" onclick="toggleBio(this)"><span class="bio-icon">üíß</span><span class="bio-label">H2O</span></div>
            </div>
        </div>

        <div class="panel" style="padding: 12px;">
            <div class="panel-head" style="margin-bottom: 10px; border:none; padding: 0;">PRO SUITE</div>
            <button class="btn-cyber" onclick="downloadPassport()">üìÑ EXPORT PASSPORT (PDF)</button>
            <button class="btn-cyber" onclick="generateLinkedIn()">üîó SHARE SUCCESS (LINKEDIN)</button>
            <button class="btn-cyber" onclick="copyBadge()">üõ°Ô∏è COPY BADGE CODE</button>
            <button class="btn-cyber" onclick="triggerChallenge()" style="border-color: var(--neon-purple); color: var(--neon-purple);">üéôÔ∏è VOICE CHALLENGE MODE</button>
        </div>

        <div class="panel" style="flex-grow: 1; background: #000;">
            <div class="panel-head" style="border-color: var(--neon-purple); color: var(--neon-purple);">AI_MENTOR</div>
            <div id="chat-history" style="flex-grow: 1; padding: 15px; font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-dim); overflow-y: auto;">
                <div style="margin-bottom: 10px;">> System initialized.</div>
            </div>
            <input id="chat-input" type="text" placeholder="Type command..." style="width: 100%; background: #111; border: none; border-top: 1px solid var(--border); padding: 12px; color: #fff; font-family: var(--font-mono); outline: none;">
        </div>
    </aside>

    <footer style="grid-column: 2/4; display: flex; align-items: center; padding: 0 20px; font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-dim); justify-content: space-between;">
        <span>STATUS: ONLINE</span>
        <span>SYNC: GITHUB, LINKEDIN</span>
    </footer>
</div>

<script>
    // --- 0. INJECTED CONSTANTS ---
    const USER_ID = {{ user.id }};
    const USER_STREAK = {{ user.weekly_streak_count or 0 }};

    // --- 1. DATA FETCH & RENDER ---
    async function initDashboard() {
        renderStreak(USER_STREAK);
        try {
            const response = await fetch('/api/dashboard/stats');
            const data = await response.json();

            renderZoneB(data.zone_b_matrix);

            if (data.weekly_plan) {
                renderWeeklyPlan(data.weekly_plan);
            } else {
                document.getElementById('view-growth').innerHTML = '<div style="padding:20px; text-align:center; color:#666;">PLAN GENERATING... REFRESH IN 5s</div>';
            }

            renderRadar(data.radar_data);

            // Context Injection
            if (data.missing_skills && data.missing_skills.length > 0) {
                 window.USER_CONTEXT_MISSING_SKILLS = data.missing_skills;
            }

        } catch (e) {
            console.error("Dashboard Load Error:", e);
            renderDataMock();
        }
    }

    function switchTab(tab) {
        document.getElementById('view-audit').style.display = tab === 'audit' ? 'block' : 'none';
        document.getElementById('view-growth').style.display = tab === 'growth' ? 'block' : 'none';

        document.getElementById('tab-audit').className = tab === 'audit' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tab-growth').className = tab === 'growth' ? 'tab-btn active' : 'tab-btn';
    }

    function renderStreak(streak) {
        const container = document.getElementById('streak-widget');
        let html = '';
        // Render 10 squares? Or just streak count?
        // "GitHub style" suggests a grid, but "streak bar" usually means progress.
        // Let's show 4-8 squares to indicate progress towards Hardcore mode (4 weeks).
        const totalSquares = Math.max(streak + 2, 4); // Show at least 4 for the goal

        for (let i = 0; i < totalSquares; i++) {
            let className = 'streak-square';
            if (i < streak) {
                className += (streak >= 4) ? ' hardcore' : ' active';
            }
            html += `<div class="${className}" title="Week ${i+1}"></div>`;
        }

        // Add Fire Icon if Hardcore
        if (streak >= 4) {
             html += `<span style="margin-left:5px; font-size:10px;">üî• HARDCORE</span>`;
        }

        container.innerHTML = html;
    }

    function renderWeeklyPlan(plan) {
        const container = document.getElementById('view-growth');
        if (!plan) return;

        let html = `<div style="padding:10px; border-bottom:1px solid var(--border); margin-bottom:10px;">
            <div style="color:var(--neon-green); font-size:0.8rem; font-weight:bold;">FOCUS: ${plan.focus_language}</div>
            <div style="font-size:0.7rem; color:var(--text-dim);">${plan.reasoning}</div>
        </div>`;

        html += `<div style="display:flex; flex-direction:column; gap:10px;">`;

        plan.routine.forEach(task => {
            const isDone = task.status === 'completed';
            const statusColor = isDone ? 'var(--neon-green)' : '#666';
            const icon = isDone ? '‚úÖ' : '‚¨ú';

            let actionBtn = '';
            if (!isDone && task.verify_url) {
                // Neon Verify Button
                actionBtn = `<button onclick="verifyTask(${task.id}, '${task.target_skill}')"
                    style="margin-top:5px; width:100%; background:rgba(16,185,129,0.1); border:1px solid var(--neon-green); color:var(--neon-green); padding:5px; font-family:var(--font-mono); font-size:0.7rem; cursor:pointer; border-radius:4px; text-transform:uppercase;">
                    VERIFY CODE
                </button>`;
            }

            html += `
            <div style="background:rgba(255,255,255,0.03); padding:10px; border-radius:4px; border-left:3px solid ${statusColor};">
                <div style="display:flex; justify-content:space-between;">
                    <span style="font-weight:bold; font-size:0.8rem; color:#fff;">${task.day}: ${task.type}</span>
                    <span>${icon}</span>
                </div>
                <div style="font-size:0.75rem; color:#ccc; margin-top:5px;">${task.task}</div>
                ${actionBtn}
            </div>`;
        });

        html += `</div>`;
        container.innerHTML = html;
    }

    async function verifyTask(taskId, targetSkill) {
        showLoader("SCANNING GITHUB FOR PROOF...");
        try {
            const response = await fetch('/api/growth/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_id: taskId, target_skill: targetSkill })
            });
            const data = await response.json();

            if (data.status === 'success') {
                showLoader(data.verified ? "VERIFIED! STREAK UPDATED" : "NO CODE FOUND YET");
                setTimeout(() => window.location.reload(), 1500); // Reload to refresh plan/streak
            } else {
                showLoader(data.message || "VERIFICATION FAILED");
                setTimeout(hideLoader, 2000);
            }
        } catch(e) {
            console.error(e);
            showLoader("ERROR CONNECTING TO SERVER");
            setTimeout(hideLoader, 2000);
        }
    }

    function renderZoneB(matrix) {
        const container = document.getElementById('view-audit');
        container.innerHTML = '';

        matrix.forEach(item => {
            const div = document.createElement('div');
            div.className = 'data-row';

            // Determine Action Buttons
            let actions = [];

            // Logic for Imposter (Critical Gap) -> Show BOTH Hotfix and Spec
            if (item.badge === 'critical' || item.status.includes("Imposter")) {
                actions.push(`<button class="tag" style="background:#ef4444; color:white; border:none; cursor:pointer; margin-right:4px;" onclick="triggerHotfix('${item.skill}')">üî• HOTFIX</button>`);
                actions.push(`<button class="tag" style="background:#8b5cf6; color:white; border:none; cursor:pointer;" onclick="generateSpec('${item.skill}')">‚ö° PROVE IT</button>`);
            }
            else if (item.action === 'ADD_TO_LINKEDIN') {
                 actions.push(`<button class="tag" style="background:#10b981; color:white; border:none; cursor:pointer;" onclick="generateLinkedIn('${item.skill}')">üîó ADD</button>`);
            }

            const statusColor = item.badge === 'success' ? 'var(--neon-green)' : (item.badge === 'critical' ? 'var(--alert)' : 'var(--neon-blue)');

            div.innerHTML = `
                <div style="width: 140px; font-weight: 600; font-size: 0.9rem; color:${statusColor}">${item.skill}</div>
                <div style="flex-grow: 1; display:flex; gap:10px; align-items:center;">
                    <div style="font-size: 0.75rem; color: #6b7280;">${item.status}</div>
                </div>
                <div style="width: 180px; text-align: right; font-family: var(--font-mono); font-size: 0.75rem; white-space: nowrap;">
                   ${actions.join('')}
                </div>`;
            container.appendChild(div);
        });
    }

    function renderRadar(radarData) {
        const ctx = document.getElementById('marketRadar').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: radarData,
            options: {
                scales: {
                    r: {
                        angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        pointLabels: { color: '#9ca3af', font: { family: 'JetBrains Mono', size: 10 } },
                        suggestedMin: 0,
                        suggestedMax: 100,
                        ticks: { display: false }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#fff', font: { family: 'Inter', size: 10 } }
                    }
                },
                elements: {
                    line: { borderWidth: 2 }
                }
            }
        });
    }

    // Fallback
    function renderDataMock() {
        const mockSkills = [
             { skill: "Python", status: "Verified", badge: "success", action: "None" },
             { skill: "Rust", status: "Imposter Detected", badge: "critical", action: "HOTFIX" }
        ];
        renderZoneB(mockSkills);
    }

    // --- 2. PRO SUITE ACTIONS ---
    function showLoader(msg) {
        const loader = document.getElementById('global-loader');
        const text = document.getElementById('loader-msg');
        loader.style.display = 'flex';
        text.innerText = msg;
    }

    function hideLoader() {
        document.getElementById('global-loader').style.display = 'none';
    }

    function downloadPassport() {
        showLoader("GENERATING PDF REPORT...");
        window.location.href = '/api/export/passport';
        setTimeout(hideLoader, 3000); // Hide after download start
    }

    async function generateLinkedIn(skill) {
        showLoader("WRITING VIRAL POST...");
        if (!skill) skill = "Software Engineering"; // Default
        try {
            const response = await fetch('/api/generate-linkedin-post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // If endpoint supports skill in body, update it. But current implementation in route picks top skill.
                // We should update route to accept body for specific skill if needed.
                // But for now, we'll stick to route logic or assume user wants top skill.
            });
            const data = await response.json();

            if (data.post_text) {
                await navigator.clipboard.writeText(data.post_text);
                showLoader("COPIED TO CLIPBOARD!");
            } else {
                alert("Error generating post");
            }
        } catch (e) {
            console.error(e);
            alert("Failed to connect to AI");
        }
        setTimeout(hideLoader, 1500);
    }

    function copyBadge() {
        const code = `[![CareerDev Badge](${window.location.origin}/api/badge/${USER_ID})]`;
        navigator.clipboard.writeText(code).then(() => {
            showLoader("COPIED TO CLIPBOARD!");
            setTimeout(hideLoader, 1000);
        });
    }

    function triggerHotfix(skill) {
        const input = document.getElementById('chat-input');
        input.value = `Help me fix my lack of ${skill} evidence.`;
        input.focus();
    }

    async function generateSpec(skill) {
        showLoader(`ARCHITECTING ${skill} PROJECT...`);
        try {
            const response = await fetch('/api/generate-project-spec', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ skill: skill })
            });
            const data = await response.json();

            if (data.spec) {
                // Download as MD file
                const blob = new Blob([data.spec], { type: 'text/markdown' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `PROJECT_${skill.toUpperCase()}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showLoader("PROJECT SPEC DOWNLOADED!");
            } else {
                showLoader("GENERATION FAILED");
            }
        } catch(e) {
             console.error(e);
             showLoader("ERROR CONNECTING TO AI");
        }
        setTimeout(hideLoader, 2000);
    }

    function triggerChallenge() {
        const input = document.getElementById('chat-input');
        input.value = "Test My Weakness";
        if (window.triggerChallenge) {
             window.triggerChallenge();
        } else {
             alert("Voice Challenge not ready.");
        }
    }

    // --- 3. MATRIX EASTER EGG (UPDATED) ---
    const konami = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
    let kIdx = 0;
    let isMatrixActive = false;

    document.addEventListener('keydown', (e) => {
        if(e.key === konami[kIdx]) {
            kIdx++;
            if(kIdx === konami.length) {
                // TOGGLE LOGIC
                isMatrixActive = !isMatrixActive;

                if (isMatrixActive) {
                    document.body.classList.add('theme-matrix');
                    addToChat("Wake up, Neo...");
                } else {
                    document.body.classList.remove('theme-matrix');
                    addToChat("Matrix simulation disabled.");
                }

                kIdx = 0;
            }
        } else { kIdx = 0; }
    });

    // --- 4. UTILS ---
    function toggleBio(el) { el.classList.toggle('active'); }
    function addToChat(msg) {
        const chat = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.style.marginBottom = '5px'; div.innerText = `> ${msg}`;
        chat.appendChild(div);
    }

    // INIT
    document.addEventListener("DOMContentLoaded", () => {
        initDashboard();
    });
</script>
{% endblock %}
