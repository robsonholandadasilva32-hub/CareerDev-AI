{% extends "dashboard_layout.html" %}

{% block dashboard_content %}

<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link href="/static/css/cyberpunk_dashboard.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* OVERRIDES FOR HORIZONTAL MENU */
    .grid-layout {
        grid-template-columns: 240px 1fr 350px !important;
    }
    .nav-dock {
        align-items: flex-start !important;
        padding-left: 15px !important;
        padding-right: 15px !important;
    }
    .nav-btn {
        width: 100% !important;
        justify-content: flex-start !important;
        padding-left: 15px !important;
        gap: 12px;
        font-size: 1rem !important; /* Adjust font size for text */
    }
    .nav-icon {
        font-size: 1.4rem; /* Keep icon size */
    }
    .nav-text {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.9rem;
    }

    /* MODAL STYLES */
    .modal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(5px);
        justify-content: center;
        align-items: center;
    }
    .modal.show {
        display: flex;
    }
    .modal-content {
        background-color: #0f111a;
        border: 1px solid var(--neon-blue);
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        color: #fff;
        font-family: 'JetBrains Mono', monospace;
        position: relative;
    }
    .modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        color: #fff;
        font-size: 20px;
        cursor: pointer;
    }
    .modal-close:hover { color: var(--alert); }

    /* ML VERSION LABEL STYLE */
    .ml-powered {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.65rem;
        color: var(--neon-purple);
        text-align: right;
        margin-top: 5px;
        opacity: 0.8;
        letter-spacing: 1px;
    }
    
    /* LINK STYLE FOR COUNTERFACTUAL TRIGGER */
    .action-link {
        color: var(--neon-blue);
        text-decoration: underline;
        cursor: pointer;
        font-size: 0.75rem;
        font-family: var(--font-mono);
        margin-top: 5px;
        display: block;
        text-align: right;
    }
    .action-link:hover { color: #fff; }

    /* MATRIX CARDS */
    .matrix-card {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 15px;
        border-radius: 6px;
        display: flex;
        gap: 15px;
        align-items: flex-start;
    }
    .matrix-card.critical { border-left: 3px solid var(--alert); }
    .matrix-card.gem { border-left: 3px solid var(--neon-blue); }
    .card-icon { font-size: 1.5rem; }
    .card-content strong { display: block; margin-bottom: 5px; font-size: 0.9rem; }
    .card-content p { margin: 0; font-size: 0.8rem; color: #ccc; }
    .card-action {
        margin-top: 10px;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-dim);
        border: 1px dashed rgba(255,255,255,0.2);
        padding: 4px 8px;
        display: inline-block;
    }

    /* KANBAN */
    .kanban-col { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }
    .kanban-card {
        background: #1a1a24;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 4px;
        border: 1px solid rgba(255,255,255,0.05);
        font-size: 0.9rem;
        position: relative;
    }
    .active-card {
        border-color: var(--neon-blue);
        box-shadow: 0 0 10px rgba(0, 240, 255, 0.1);
    }
    .completed-card {
        border-color: var(--neon-green);
        opacity: 0.7;
    }
    .card-badge {
        display: inline-block;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 3px;
        background: rgba(255,255,255,0.1);
        margin-bottom: 5px;
    }
</style>

<div class="grid-layout">

    <nav class="panel nav-dock">
        <div class="brand-logo" style="margin-left: 10px;">C/AI</div>
        <a href="/dashboard" class="nav-btn active"><span class="nav-icon">‚åò</span> <span class="nav-text">Dashboard</span></a>
        <a href="/career/analyze-resume" class="nav-btn"><span class="nav-icon">‚ö°</span> <span class="nav-text">Resume Analyzer</span></a>
        <a href="/accessibility" class="nav-btn"><span class="nav-icon">üß†</span> <span class="nav-text">Accessibility</span></a>
        <a href="/security" class="nav-btn"><span class="nav-icon">üõ°Ô∏è</span> <span class="nav-text">Security</span></a>
        <a href="/legal" class="nav-btn"><span class="nav-icon">‚öñÔ∏è</span> <span class="nav-text">Legal & About</span></a>
        <div style="flex-grow: 1;"></div>
        <a href="/logout" class="nav-btn alert-color"><span class="nav-icon">‚úï</span> <span class="nav-text">Logout</span></a>
    </nav>

    <div class="panel status-bar" style="grid-column: 2/4;">
        <span class="feed-label">REAL_TIME_FEED ::</span>
        <marquee class="feed-text">
            SYSTEM ONLINE... USER: {{ user.email }}... CONNECTED TO GITHUB API... ML_RISK_ENGINE: ACTIVE...
        </marquee>
    </div>

    <main class="panel" style="grid-column: 2/3;">
        <div class="panel-head tab-header">
            <div>
                <button class="tab-btn active" onclick="switchTab('audit')">AUDIT VIEW</button>
                <button class="tab-btn" onclick="switchTab('plan')">WEEKLY PLAN</button>
            </div>

            <div style="display:flex; align-items:center; gap:10px;">
                
                <div class="streak-bar" style="display: flex; gap: 4px; align-items: center; margin-right: 10px;">
                    {% for week in weekly_history | reverse %}
                        <div title="Week {{ week.week }}: {{ week.completion }}%"
                             style="width: 12px; height: 12px; border-radius: 2px;
                             background-color: {% if week.completion >= 80 %}#10b981{% elif week.completion >= 50 %}#eab308{% else %}#374151{% endif %};">
                        </div>
                    {% endfor %}
                </div>

                <div class="streak-badge" aria-label="Click to analyze risk factors" style="cursor: pointer;">
                    üî• STREAK: {{ user_streak }} WEEKS
                </div>

                {% if career_data.career_forecast.risk_level == 'HIGH' %}
                    <div class="streak-badge risk-high" onclick="openRiskModal()">‚ö† HIGH RISK</div>
                {% elif career_data.career_forecast.risk_level == 'MEDIUM' %}
                    <div class="streak-badge risk-medium" onclick="openRiskModal()">üü° MEDIUM RISK</div>
                {% else %}
                    <div class="streak-badge" style="border-color: #10b981; color: #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);">üü¢ STABLE</div>
                {% endif %}

                {% if career_data.weekly_plan.mode == 'ACCELERATOR' %}
                    <div class="streak-badge accelerator">üöÄ ACCELERATOR</div>
                {% endif %}
            </div>
        </div>

        <div id="view-audit" style="padding:20px; padding-bottom: 50px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h4 style="margin-bottom: 10px; opacity: 0.8;">SKILL RADAR</h4>
                    <canvas id="radarChart"></canvas>
                </div>
                
                <div style="display: flex; flex-direction: column; justify-content: center;">
                    <div style="font-size:0.8rem; letter-spacing: 1px;">MARKET ALIGNMENT</div>
                    <div style="font-size:3rem; font-weight:800; color: #00f0ff; text-shadow: 0 0 10px #00f0ff;">
                        {{ market_score }}/100
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h4 style="margin-bottom: 10px; opacity: 0.8; font-size: 0.9rem;">RISK MODEL DIVERGENCE (RULE vs ML)</h4>
                        <div style="height: 150px;">
                            <canvas id="riskCompareChart"></canvas>
                        </div>
                        
                        <div class="ml-powered">
                            Powered by ML v{{ career_data.career_forecast.model_version }}
                            <span style="color: var(--text-dim); margin-left: 5px;">
                                [EXP: {{ career_data.career_forecast.experiment }}]
                            </span>
                        </div>
                    </div>

                    <div class="chart-container" style="position: relative; height:200px; width:100%; margin-top: 20px;">
                        <h4 style="color:var(--text-muted); font-size: 0.9em; margin-bottom: 10px;">
                            <i class="fas fa-balance-scale"></i> RISK DRIVERS (AI EXPLANATION)
                        </h4>
                        <canvas id="shapChart"></canvas>
                    </div>

                    {% if career_data.benchmark %}
                    <div class="panel">
                      <div class="panel-head">CONTEXTUAL BENCHMARK</div>
                      <div style="padding:12px; font-size: 0.8rem;">
                        {{ career_data.benchmark.message }}
                      </div>
                    </div>
                    {% endif %}

                    {% if career_data.team_benchmark %}
                    <div class="panel" style="border-left: 4px solid var(--neon-blue); margin-bottom: 20px;">
                      <div class="panel-head">
                        <i class="fas fa-users"></i> TEAM BENCHMARK
                      </div>
                      <div style="padding:15px;">
                        <div style="font-size: 0.9rem; color: #cbd5e1; margin-bottom: 5px;">
                          {{ career_data.team_benchmark.context }}
                        </div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #fff;">
                          Top {{ 100 - career_data.team_benchmark.percentile }}%
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
                          {{ career_data.team_benchmark.message }}
                        </div>
                      </div>
                    </div>
                    {% endif %}

                    {% if career_data.team_health %}
                    <div class="panel" style="text-align: center; border-top: 4px solid {% if career_data.team_health.health_score > 75 %}var(--neon-green){% elif career_data.team_health.health_score > 50 %}#facc15{% else %}#ef4444{% endif %};">
                      <div class="panel-head">
                        <i class="fas fa-heartbeat"></i> TEAM HEALTH
                      </div>
                      <div style="font-size: 2.5rem; font-weight: 700; margin: 10px 0; color: #fff;">
                        {{ career_data.team_health.health_score }}%
                      </div>
                      <div style="font-size: 1rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">
                        {{ career_data.team_health.label }}
                      </div>
                      <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        Based on {{ career_data.team_health.member_count }} members
                      </div>
                    </div>
                    {% endif %}

                    {% if career_data.team_burnout %}
                    <div class="panel" style="text-align: center; border-top: 4px solid {% if career_data.team_burnout.level == 'HIGH' %}#ef4444{% elif career_data.team_burnout.level == 'MEDIUM' %}#facc15{% else %}#10b981{% endif %}; margin-bottom: 20px;">
                      <div class="panel-head">
                          <i class="fas fa-fire"></i> TEAM BURNOUT RISK
                      </div>
                      <div style="font-size: 2.5rem; font-weight: 700; margin: 10px 0; color: #fff;">
                        {{ career_data.team_burnout.burnout_score }}%
                      </div>
                      <div style="margin-top: 5px; font-family: 'JetBrains Mono', monospace;">
                      LEVEL:
                      <span style="color: {% if career_data.team_burnout.level == 'HIGH' %}#ef4444{% elif career_data.team_burnout.level == 'MEDIUM' %}#facc15{% else %}#10b981{% endif %}; font-weight: bold;">
                        {{ career_data.team_burnout.level }}
                      </span>
                      </div>
                      <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        AVG: {{ career_data.team_burnout.avg_risk }} VAR: {{ career_data.team_burnout.variance }}
                      </div>
                    </div>
                    {% endif %}

                    {% if career_data.exit_simulation %}
                    <div class="panel" style="border-left: 4px solid var(--neon-purple);">
                      <div class="panel-head">
                        <i class="fas fa-user-minus"></i> ANCHOR EXIT SIMULATION
                      </div>
                      <div style="padding: 15px;">
                        <div style="font-size: 0.8rem; color: #ccc; margin-bottom: 10px;">
                          If your most stable dev leaves:
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: #888;">CURRENT RISK</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: #fff;">{{ career_data.exit_simulation.current_avg }}%</div>
                            </div>
                            <div style="font-size: 1.5rem; color: #666;">&rarr;</div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: #888;">SIMULATED</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: #fff;">{{ career_data.exit_simulation.new_avg_if_exit }}%</div>
                            </div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; text-align: center; border: 1px dashed var(--neon-purple);">
                            <span style="font-size: 0.8rem; color: var(--text-dim);">TEAM RISK SPIKE:</span>
                            <span style="font-size: 1rem; font-weight: 800; color: {% if career_data.exit_simulation.impact > 5 %}#ef4444{% else %}#eab308{% endif %}; margin-left: 5px;">
                                +{{ career_data.exit_simulation.impact }}%
                            </span>
                        </div>
                      </div>
                    </div>
                    {% endif %}

                    {% if career_data.hire_simulation %}
                    <div class="panel" style="border-left: 4px solid var(--neon-green); margin-top: 20px;">
                      <div class="panel-head">
                        <i class="fas fa-user-plus"></i> HIRE SIMULATION
                      </div>
                      <div style="padding: 15px;">
                        <div style="font-size: 0.8rem; color: #ccc; margin-bottom: 10px;">
                           Simulation Base: Senior Dev (Risk Score: {{ career_data.hire_simulation.hypothetical_risk }})
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: #888;">CURRENT RISK</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: #fff;">{{ career_data.hire_simulation.current_avg }}%</div>
                            </div>
                            <div style="font-size: 1.5rem; color: #666;">&rarr;</div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: #888;">SIMULATED</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: #fff;">{{ career_data.hire_simulation.new_avg_with_hire }}%</div>
                            </div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; text-align: center; border: 1px dashed var(--neon-green);">
                            <span style="font-size: 0.8rem; color: var(--text-dim);">IMPACT:</span>
                            <span style="font-size: 1rem; font-weight: 800; color: var(--neon-green); margin-left: 5px;">
                                {{ career_data.hire_simulation.impact }}%
                            </span>
                        </div>
                      </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div style="margin-top:20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                
                <div>
                    <h4 style="margin-bottom: 15px; opacity: 0.8;">CONFIDENCE TIMELINE</h4>
                    <div style="height: 200px;">
                        <canvas id="skillTimelineChart"></canvas>
                    </div>
                </div>

                <div>
                    <h4 style="margin-bottom: 15px; opacity: 0.8;">RISK FORECAST HISTORY</h4>
                    {% if career_data.risk_timeline %}
                    <div style="height: 200px;">
                        <canvas id="riskTimeline"></canvas>
                    </div>
                    {% endif %}
                    <span class="action-link" onclick="openCounterfactualModal()">What lowers my risk? &rarr;</span>
                </div>
            </div>

            <div class="risk-matrix" style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <h3 style="margin-bottom: 20px; color: #fff;">RISK & OPPORTUNITY MATRIX</h3>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    {% for risk in career_data.career_risks if risk.level == 'CRITICAL' %}
                    <div class="matrix-card critical">
                        <div class="card-icon">‚ö†Ô∏è</div>
                        <div class="card-content">
                            <strong>IMPOSTER DETECTOR: {{ risk.skill }}</strong>
                            <p>{{ risk.message }}</p>
                            <div class="card-action">{{ risk.action }}</div>
                        </div>
                    </div>
                    {% endfor %}

                    {% for gem in career_data.hidden_gems %}
                    <div class="matrix-card gem">
                        <div class="card-icon">üíé</div>
                        <div class="card-content">
                            <strong>HIDDEN GEM: {{ gem.skill }}</strong>
                            <p>{{ gem.message }}</p>
                            <div class="card-action">{{ gem.action }}</div>
                        </div>
                    </div>
                    {% endfor %}

                    {% if not career_data.career_risks and not career_data.hidden_gems %}
                        <div class="matrix-card" style="border-left: 3px solid #10b981;">
                             <div class="card-icon">‚úÖ</div>
                             <div class="card-content">
                                <strong>ALL CLEAR</strong>
                                <p>No critical risks or hidden gems detected. Keep optimizing!</p>
                             </div>
                        </div>
                    {% endif %}
                </div>

                <div class="skill-confidence-list" style="margin-top: 30px;">
                    <h4 style="opacity: 0.8; margin-bottom: 10px;">VERIFIED SKILL CONFIDENCE</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        {% for skill, score in career_data.skill_confidence.items() %}
                        <div class="skill-tag" style="border: 1px solid {% if score > 80 %}var(--neon-green){% elif score > 40 %}var(--neon-yellow){% else %}var(--alert){% endif %}; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; background: rgba(0,0,0,0.3);">
                            {{ skill }} <span style="opacity: 0.7; margin-left: 5px;">{{ score }}%</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div id="view-plan" style="display:none;padding:20px;">
            {% if career_data.multi_week_plan %}
            <div class="panel" style="margin-top: 20px;">
              <div class="panel-head">
                <i class="fas fa-road"></i> 4-WEEK ADAPTIVE ROADMAP
              </div>
              <div class="panel-body" style="padding: 15px;">
                <div style="display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px;">
                  {% for week in career_data.multi_week_plan %}
                    <div style="min-width: 200px; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px; border-left: 3px solid var(--neon-blue);">
                      <strong style="display:block; color: var(--neon-blue); margin-bottom: 8px; border-bottom: 1px solid #444; padding-bottom: 4px;">
                        {{ week.week }}
                      </strong>
                      <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.85em;">
                        {% for task in week.tasks %}
                          <li style="margin-bottom: 6px;">
                            <i class="fas fa-check-circle" style="color: #444; margin-right: 5px;"></i>
                            {{ task.task }}
                            <div style="color: var(--neon-green); font-size: 0.8em; margin-left: 20px;">
                              {{ task.expected_impact }}
                            </div>
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
            {% endif %}

            <div class="kanban-header">
                CURRENT FOCUS:
                <span style="color: #fcee0a;">{{ career_data.weekly_plan.focus | upper }}</span>
            </div>

            <div class="kanban-board" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div class="kanban-col">
                    <h4 style="border-bottom: 2px solid #555; padding-bottom: 10px; margin-bottom: 15px;">TO DO</h4>
                    {% for task in career_data.weekly_plan.tasks if task.status == 'pending' %}
                        <div class="kanban-card">
                            <div class="card-badge">{{ task.day }}</div>
                            <div>{{ task.task }}</div>
                        </div>
                    {% endfor %}
                </div>

                <div class="kanban-col">
                    <h4 style="border-bottom: 2px solid var(--neon-blue); padding-bottom: 10px; margin-bottom: 15px; color: var(--neon-blue);">IN PROGRESS</h4>
                    {% for task in career_data.weekly_plan.tasks if task.status == 'in_progress' %}
                        <div class="kanban-card active-card">
                            <div class="card-badge" style="background: var(--neon-blue); color: #000;">{{ task.day }}</div>
                            <div style="font-weight: bold; margin-bottom: 5px;">{{ task.task }}</div>
                            {% if task.type == 'Code' %}
                                <button class="nav-btn small" style="margin-top: 10px; font-size: 0.8rem; width: 100%; justify-content: center; border: 1px solid var(--neon-blue);" onclick="verifyTask(this, {{ task.id }})">VERIFY REPO</button>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <div class="kanban-col">
                    <h4 style="border-bottom: 2px solid var(--neon-green); padding-bottom: 10px; margin-bottom: 15px; color: var(--neon-green);">VERIFIED</h4>
                    {% for task in career_data.weekly_plan.tasks if task.status == 'completed' %}
                          <div class="kanban-card completed-card">
                            <div class="card-badge" style="background: var(--neon-green); color: #000;">{{ task.day }}</div>
                            <div style="text-decoration: line-through;">{{ task.task }}</div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </main>

</div>

<div id="riskModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeRiskModal()">√ó</span>
        <h3 style="color: var(--alert); margin-top: 0;">‚ö†Ô∏è RISK ANALYSIS</h3>
        <p style="opacity: 0.7; font-size: 0.8rem; margin-bottom: 15px;">AI EXPLAINABILITY REPORT</p>
        
        <div id="riskDetails" style="line-height: 1.6;">
            Analyzing...
        </div>
        
        <div style="margin-top: 20px; text-align: right;">
            <button onclick="closeRiskModal()" class="nav-btn" style="width: auto; height: auto; padding: 5px 15px; font-size: 0.8rem; border: 1px solid var(--neon-blue); color: var(--neon-blue);">ACKNOWLEDGE</button>
        </div>
    </div>
</div>

<div id="counterfactualModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeCounterfactualModal()">√ó</span>
        <h3 style="color: var(--neon-green); margin-top: 0;">üå± RISK REDUCTION PATH</h3>
        <p style="opacity: 0.7; font-size: 0.8rem; margin-bottom: 15px;">COUNTERFACTUAL ANALYSIS SIMULATION</p>
        
        {% set cf = career_data.get('counterfactual', {}) %}
        {% if cf %}
            <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">
                {{ cf.summary }}
            </p>
            
            <ul style="list-style: none; padding: 0;">
              {% for item in cf.actions %}
                <li style="margin-bottom: 12px; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px;">
                  <div style="color: #fff; margin-bottom: 4px;">{{ item.action }}</div>
                  <div style="color:var(--neon-green); font-size: 0.85rem; font-weight: bold;">
                    ‚Üí {{ item.impact }}
                  </div>
                </li>
              {% endfor %}
            </ul>
        {% else %}
            <p>No actionable scenarios generated at this time.</p>
        {% endif %}
        
        <div style="margin-top: 20px; text-align: right;">
            <button onclick="closeCounterfactualModal()" class="nav-btn" style="width: auto; height: auto; padding: 5px 15px; font-size: 0.8rem; border: 1px solid var(--neon-green); color: var(--neon-green);">CLOSE</button>
        </div>
    </div>
</div>

<script>
/* ---------------- CHART SETUP ---------------- */
new Chart(document.getElementById('radarChart'), {
    type: 'radar',
    data: {{ career_data.zone_a_radar | tojson }},
    options: {
        scales: {
            r: {
                min: 0, max: 100,
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                pointLabels: { color: '#fff' }
            }
        },
        plugins: { legend: { display: false } }
    }
});

const riskLevel = "{{ career_data.career_forecast.risk_level }}";
const riskColor = riskLevel === "HIGH" ? "#ef4444" : riskLevel === "MEDIUM" ? "#eab308" : "#10b981";

new Chart(document.getElementById("riskCompareChart"), {
  type: "bar",
  data: {
    labels: ["Rule-Based", "ML-Based"],
    datasets: [{
      label: 'Risk Score',
      data: [
        {{ career_data.career_forecast.rule_risk | default(0) }},
        {{ career_data.career_forecast.ml_risk | default(0) }}
      ],
      backgroundColor: [riskColor, riskColor], 
      borderWidth: 0,
      barThickness: 30
    }]
  },
  options: {
    indexAxis: 'y',
    responsive: true,
    maintainAspectRatio: false,
    scales: {
        x: { min: 0, max: 100, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#fff' } },
        y: { grid: { display: false }, ticks: { color: '#fff', font: { family: 'JetBrains Mono' } } }
    },
    plugins: { legend: { display: false } }
  }
});

/* ---------------- SHAP VISUALIZATION ---------------- */
const shapData = {{ career_data.shap_visual | tojson }};
if (shapData && shapData.values) {
    const shapColors = shapData.values.map(v => v > 0 ? '#ef4444' : '#10b981');

    new Chart(document.getElementById('shapChart'), {
        type: 'bar',
        data: {
            labels: shapData.labels,
            datasets: [{
                label: 'Risk Contribution',
                data: shapData.values,
                backgroundColor: shapColors,
                borderWidth: 0,
                barThickness: 30
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: '#fff' }
                },
                y: {
                    grid: { display: false },
                    ticks: { color: '#fff', font: { family: 'JetBrains Mono' } }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

/* ---------------- RISK TIMELINE CHART ---------------- */
{% if career_data.risk_timeline %}
new Chart(document.getElementById("riskTimeline"), {
  type: "line",
  data: {
    labels: {{ career_data.risk_timeline['labels'] | tojson }},
    datasets: [{
      label: "Projected Risk",
      data: {{ career_data.risk_timeline.data_points | tojson }},
      borderColor: "{{ career_data.career_forecast.color | default('#ef4444') }}", 
      backgroundColor: "rgba(0,0,0,0)",
      tension: 0.4,
      pointRadius: 2
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
        y: { min: 0, max: 100, grid: { color: 'rgba(255,255,255,0.1)' } },
        x: { grid: { display: false } }
    },
    plugins: { legend: { display: false } }
  }
});
{% endif %}

/* ---------------- SKILL TIMELINE ---------------- */
async function loadSkillTimeline(){
    try {
        const res = await fetch("/api/analytics/skill-timeline");
        const data = await res.json();
        const labels = [];
        const datasets = [];
        const colors = ['#00f0ff', '#fcee0a', '#ff003c'];

        Object.keys(data).forEach((skill, index) => {
            if(!labels.length){
                data[skill].forEach(p => labels.push(p.date.split("T")[0]));
            }
            datasets.push({
                label: skill,
                data: data[skill].map(p => p.confidence),
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length],
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 0
            });
        });

        new Chart(document.getElementById("skillTimelineChart"), {
            type:"line",
            data:{ labels, datasets },
            options:{
                responsive: true,
                maintainAspectRatio: false,
                scales:{
                    y:{ min:0, max:100, grid: { color: 'rgba(255,255,255,0.1)' } },
                    x:{ grid: { display: false } }
                }
            }
        });
    } catch (e) {
        console.error("Failed to load timeline", e);
    }
}
document.addEventListener("DOMContentLoaded", loadSkillTimeline);

/* ---------------- UI LOGIC ---------------- */
function switchTab(tab){
    document.getElementById('view-audit').style.display = 'none';
    document.getElementById('view-plan').style.display = 'none';
    document.getElementById('view-' + tab).style.display = 'block';
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
}

/* ---------------- MODAL LOGIC (RISK) ---------------- */
async function openRiskModal() {
    const modal = document.getElementById("riskModal");
    const details = document.getElementById("riskDetails");
    
    modal.classList.add("show");
    details.innerHTML = "Accessing Neural Network Interpretation...";

    try {
        const res = await fetch("/api/risk/explain");
        const data = await res.json();
        
        let html = `<strong>SUMMARY:</strong> ${data.summary}<br><br>`;
        if(data.factors) {
            html += "<strong>KEY FACTORS:</strong><ul>";
            data.factors.forEach(f => {
                html += `<li>${f.factor}: <span style="color:${f.impact === 'High' ? '#ef4444' : '#eab308'}">${f.impact}</span></li>`;
            });
            html += "</ul>";
        }
        details.innerHTML = html;

    } catch (e) {
        details.innerHTML = "Error fetching explanation. Neural link offline.";
    }
}

function closeRiskModal() {
    document.getElementById("riskModal").classList.remove("show");
}

/* ---------------- MODAL LOGIC (COUNTERFACTUAL) ---------------- */
function openCounterfactualModal() {
    document.getElementById("counterfactualModal").classList.add("show");
}

function closeCounterfactualModal() {
    document.getElementById("counterfactualModal").classList.remove("show");
}

// Global Click Handler for Modals
window.onclick = function(event) {
    const riskModal = document.getElementById("riskModal");
    const cfModal = document.getElementById("counterfactualModal");
    
    if (event.target == riskModal) closeRiskModal();
    if (event.target == cfModal) closeCounterfactualModal();
}

document.addEventListener("DOMContentLoaded", () => {
    const streakBadge = document.querySelector(".streak-badge");
    if(streakBadge) {
        streakBadge.onclick = openRiskModal;
    }
    
    const highRisk = document.querySelector(".risk-high");
    if(highRisk) highRisk.onclick = openRiskModal;
    
    const medRisk = document.querySelector(".risk-medium");
    if(medRisk) medRisk.onclick = openRiskModal;
});

/* ---------------- VERIFY TASK (KANBAN) ---------------- */
async function verifyTask(btn, taskId) {
    const originalText = btn.innerText;
    btn.innerText = "SCANNING...";
    btn.disabled = true;

    try {
        const res = await fetch(`/api/verify/task/${taskId}`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
            btn.innerText = "VERIFIED!";
            btn.style.backgroundColor = "var(--neon-green)";
            btn.style.color = "#000";

            // Reload page to update Kanban board state
            setTimeout(() => location.reload(), 1000);
        } else {
            btn.innerText = "FAILED";
            btn.style.borderColor = "var(--alert)";
            alert(data.message);
            setTimeout(() => {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.style.borderColor = "var(--neon-blue)";
            }, 2000);
        }
    } catch (e) {
        console.error(e);
        btn.innerText = "ERROR";
    }
}
</script>

{% endblock %}
