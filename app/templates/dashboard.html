{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>

<div class="dashboard-grid">
    <!-- SECURITY HEADER -->
    <div class="card security-status" id="tour-security">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3>üîí Security Active</h3>
                <p style="color: #00ff88; font-size: 0.9em;">Your account is protected.</p>
            </div>
            <div>
                <a href="/dashboard/security" class="btn-outline">Manage Security</a>
            </div>
        </div>
    </div>

    <!-- HEALTH & ERGONOMICS -->
    <div class="card health-monitor" id="tour-health">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <h3>ü©∫ Health & Ergonomics</h3>
                <!-- Pulsing Dot -->
                <div id="health-indicator" style="display: none; width: 10px; height: 10px; background: #00ff88; border-radius: 50%; box-shadow: 0 0 10px #00ff88; animation: pulse 1s infinite;"></div>
            </div>

            <!-- Toggle Switch -->
            <label class="switch">
                <input type="checkbox" id="posture-toggle" onchange="togglePostureCheck()">
                <span class="slider round"></span>
            </label>
        </div>
        <p style="color: #9ca3af; font-size: 0.9em; margin-top: 5px;">
            AI-powered posture analysis. We'll check your posture every 5 minutes and alert you if you're slouching.
            <br><small style="color: #64748b;">(Camera access required. Images are processed and discarded.)</small>
        </p>
    </div>

    <!-- ACCESSIBILITY SPOTLIGHT (NEW) -->
    <div class="card a11y-spotlight" id="tour-a11y">
        <div class="a11y-spotlight-content">
            <div class="a11y-spotlight-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
            </div>
            <div class="a11y-spotlight-text">
                <h4>Accessibility Spotlight</h4>
                <p>
                    Customize your experience with our new accessibility tools.
                </p>
            </div>
            <a href="/dashboard/accessibility" class="btn-outline a11y-btn">
                Go to Accessibility
            </a>
        </div>
    </div>

    <!-- QUICK ACTIONS -->
    <div class="card actions" style="margin-top: 20px;">
        <h3>‚ö° Quick Actions</h3>
        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
            <a href="/dashboard/security" class="btn-action">
                <span>üîê</span> Manage Account Security
            </a>
            <a href="/career/analytics" class="btn-action">
                <span>üìä</span> Advanced Analytics
            </a>
            <a href="#" class="btn-action" onclick="document.getElementById('resume-modal').style.display='flex'">
                <span>üìÑ</span> Analyze Resume
            </a>
            <a href="/logout" class="btn-action danger">
                <span>üö™</span> Secure Logout
            </a>
        </div>
    </div>

    <style>
        .btn-action {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            color: var(--text-color);
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .btn-action:hover {
            background: rgba(0, 243, 255, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
            text-decoration: none;
            transform: translateY(-2px);
        }
        .btn-action.danger:hover {
            background: rgba(255, 0, 85, 0.1);
            border-color: var(--error-color);
            color: var(--error-color);
        }
    </style>

    <!-- USER IDENTITY -->
    <div class="card user-identity" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h2>
                    Welcome, {{ email }}
                    {% if user.is_premium %}
                        <span style="font-size: 0.6em; background: gold; color: black; padding: 2px 8px; border-radius: 10px; vertical-align: middle;">PREMIUM</span>
                    {% else %}
                         <a href="/subscription/checkout" style="font-size: 0.5em; background: #374151; color: white; padding: 4px 8px; border-radius: 10px; text-decoration: none; vertical-align: middle; border: 1px solid gold;">Upgrade to Premium</a>
                    {% endif %}
                </h2>
                <div class="stats-row" style="display: flex; gap: 20px; margin-top: 15px;">
                    <div class="stat-item">
                        <span class="label">Level</span>
                        <span class="value">{{ profile.level }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="label">Focus Area</span>
                        <span class="value">{{ profile.focus }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="label">AI Tokens</span>
                        {% if user.is_premium %}
                            <span class="value" style="color: gold;">‚àû Unlimited</span>
                        {% else %}
                            <span class="value">10/100</span>
                        {% endif %}
                    </div>
                     {% if user.is_premium %}
                    <div class="stat-item">
                        <span class="label">Support</span>
                        <span class="value" style="color: var(--secondary-color);">VIP ‚òÖ</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- BADGES HALL -->
            <div class="badges-hall" style="display: flex; gap: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px;">
                {% if badges %}
                    {% for ub in badges %}
                    <div class="badge-item"
                         onclick="openBadgeModal('{{ ub.badge.name }}', '{{ ub.badge.description }}', '{{ ub.badge.icon }}')"
                         title="{{ ub.badge.name }}: {{ ub.badge.description }}"
                         style="font-size: 1.5rem; cursor: pointer; transition: transform 0.2s;">
                        {{ ub.badge.icon }}
                    </div>
                    {% endfor %}
                {% else %}
                    <span style="color: #6b7280; font-size: 0.8rem;">Earn badges by completing tasks!</span>
                {% endif %}
            </div>
        </div>

        <div class="progress-container" style="margin-top: 15px; background: #374151; height: 10px; border-radius: 5px;">
            <div class="progress-bar" style="width: 78%; background: var(--primary-color); height: 100%; border-radius: 5px; box-shadow: 0 0 10px var(--primary-color);"></div>
        </div>
    </div>

    <!-- CAREER TRENDS (DYNAMIC) -->
    <div class="card trends" style="margin-top: 20px;">
        <h3>Market Trends</h3>
        <p style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px;">Real-time market monitoring for your profile.</p>

        <div class="trends-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            {% for tech, demand in profile.trends.items() %}
            <div class="trend-card" style="background: rgba(255, 255, 255, 0.03); padding: 15px; border-radius: 8px; border: 1px solid var(--border-soft);">
                <h4 style="color: {% if demand == 'Very High' %}#00ff88{% elif demand == 'High' %}#00f3ff{% else %}#fbbf24{% endif %}; margin: 0 0 10px 0;">
                    {{ tech }}
                </h4>
                <p style="margin: 0; font-size: 0.9rem;">Demand: <strong>{{ demand }}</strong></p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- AI GENERATED PLAN -->
    <div class="card projects" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Personalized Plan (AI Driven)</h3>
            <span class="badge">Updated Weekly</span>
        </div>

        <div class="plan-list" style="margin-top: 15px; display: grid; gap: 15px;">
            {% for item in plan %}
            <div class="plan-item" style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-color);">
                <div style="display: flex; justify-content: space-between;">
                    <h4 style="margin: 0;">{{ item.title }}</h4>
                    <span style="font-size: 0.8rem; padding: 2px 8px; border-radius: 10px; background: rgba(255, 255, 255, 0.1);">
                        {{ item.technology }}
                    </span>
                </div>
                <p style="color: #d1d5db; font-size: 0.9rem; margin: 8px 0;">{{ item.description }}</p>

                {% if item.resources %}
                <div style="margin-top: 10px; font-size: 0.85rem;">
                    <strong>üìö Resources:</strong>
                    {% for res in item.resources %}
                        <a href="{{ res }}" target="_blank" style="color: var(--accent-blue);">Link {{ loop.index }}</a>
                    {% endfor %}
                </div>
                {% endif %}

                <div style="margin-top: 10px; text-align: right;">
                    <small style="color: #6b7280;">Deadline: {{ item.due_date.strftime('%d/%m') if item.due_date else 'No deadline' }}</small>
                </div>
            </div>
            {% else %}
            <p>Generating your AI personalized plan...</p>
            {% endfor %}
        </div>
    </div>

    <!-- NETWORKING & COMMUNITY -->
    <div class="card networking" style="margin-top: 20px;">
        <h3>ü§ù Networking & Community</h3>
        <p>Suggested connections based on your focus in <strong>{{ profile.focus }}</strong>:</p>
        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px;">
             <a href="https://discord.gg/rust-lang" target="_blank" class="btn-action">Rust Discord</a>
             <a href="https://gophers.slack.com/" target="_blank" class="btn-action">Gophers Slack</a>
        </div>
    </div>
</div>

<!-- BADGE SHARE MODAL -->
<div id="badge-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 400px; background: #0f172a; border: 1px solid var(--secondary-color); text-align: center;">
        <div id="badge-icon-display" style="font-size: 4rem; margin-bottom: 10px;">üèÜ</div>
        <h3 id="badge-name-display" style="margin: 0; color: var(--secondary-color);">Badge Name</h3>
        <p id="badge-desc-display" style="color: #cbd5e1; font-size: 0.9rem; margin: 10px 0;">Description</p>

        <div style="margin-top: 20px; display: grid; gap: 10px;">
            <button onclick="shareBadge('linkedin')" class="btn-action" style="justify-content: center; background: #0077b5; border: none; color: white;">
                Share on LinkedIn
            </button>
            <button onclick="shareBadge('twitter')" class="btn-action" style="justify-content: center; background: #1da1f2; border: none; color: white;">
                Share on X (Twitter)
            </button>
        </div>

        <button onclick="document.getElementById('badge-modal').style.display='none'" class="btn-outline" style="margin-top: 15px; width: 100%;">Close</button>
    </div>
</div>

<!-- RESUME ANALYZER MODAL -->
<div id="resume-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 600px; background: #0f172a; border: 1px solid var(--primary-color);">
        <h3 style="margin-top: 0; color: var(--primary-color);">ü§ñ Smart Resume Analysis</h3>
        <p style="font-size: 0.9rem; color: #cbd5e1;">Paste your resume text below. Our AI will identify gaps for your target role.</p>

        <textarea id="resume-text" rows="10" style="width: 100%; background: #1e293b; color: white; border: 1px solid #334155; border-radius: 6px; padding: 10px;" placeholder="Paste your CV here..."></textarea>

        <div id="resume-result" style="display: none; margin-top: 15px; padding: 10px; background: rgba(0, 255, 136, 0.1); border-radius: 6px;">
            <h4 id="res-score" style="margin: 0; color: var(--secondary-color);">Score: 0/100</h4>
            <p id="res-feedback" style="font-size: 0.9rem;"></p>
            <ul id="res-gaps" style="font-size: 0.85rem; color: #fbbf24;"></ul>
        </div>

        <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
            <button onclick="document.getElementById('resume-modal').style.display='none'" class="btn-outline">Close</button>
            <button onclick="analyzeResume()" class="btn">Analyze & Update Plan</button>
        </div>
    </div>
</div>

<style>
@keyframes pulse { 0% { opacity: 0.5; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.9); } }
@keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
/* Switch Styles */
.switch { position: relative; display: inline-block; width: 50px; height: 26px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #374151; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #00f3ff; }
input:checked + .slider:before { transform: translateX(24px); }
</style>

<script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
<script>
// Posture Check Logic
let postureInterval = null;
let stream = null;

async function togglePostureCheck() {
    const toggle = document.getElementById('posture-toggle');
    const indicator = document.getElementById('health-indicator');

    // SAVE STATE
    localStorage.setItem('posture-check', toggle.checked);

    if (toggle.checked) {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });

            // Create hidden video element to hold stream
            let video = document.getElementById('posture-video');
            if (!video) {
                video = document.createElement('video');
                video.id = 'posture-video';
                video.style.display = 'none';
                document.body.appendChild(video);
            }
            video.srcObject = stream;
            await video.play();

            indicator.style.display = 'block';

            // Initial check
            setTimeout(captureAndAnalyze, 2000); // Wait for camera warm up

            // Start interval (5 minutes = 300000 ms)
            postureInterval = setInterval(captureAndAnalyze, 300000);

            showToast("Posture Check Enabled", "success");

        } catch (err) {
            console.error("Camera Error:", err);
            toggle.checked = false;
            indicator.style.display = 'none';
            alert("Could not access camera. Please allow camera permissions to use this feature.");
        }
    } else {
        // Disable
        if (postureInterval) clearInterval(postureInterval);
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        indicator.style.display = 'none';
        showToast("Posture Check Disabled", "info");
    }
}

async function captureAndAnalyze() {
    const video = document.getElementById('posture-video');
    if (!video || !stream) return;

    try {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        // Low quality to save bandwidth
        const base64 = canvas.toDataURL('image/jpeg', 0.5);

        // Send to backend
        const res = await fetch('/api/v1/monitoring/analyze-posture', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: base64 })
        });

        if (res.status === 401) {
            showToast("Session expired. Please login again.", "warning");
            return;
        }

        const data = await res.json();

        if (data.status === 'poor_posture') {
            showToast(data.message, "warning");
        }

    } catch (e) {
        console.error("Analysis failed:", e);
    }
}

function showToast(msg, type) {
    const toast = document.createElement('div');
    toast.innerText = msg;
    toast.style.position = 'fixed';
    toast.style.bottom = '20px';
    toast.style.right = '20px';
    toast.style.padding = '15px 25px';
    toast.style.borderRadius = '8px';
    toast.style.color = 'white';
    toast.style.zIndex = '10000';
    toast.style.fontWeight = 'bold';
    toast.style.boxShadow = '0 4px 6px rgba(0,0,0,0.3)';
    toast.style.animation = 'slideIn 0.3s ease-out';

    if (type === 'warning') toast.style.background = '#ff0055';
    else if (type === 'success') toast.style.background = '#00ff88';
    else toast.style.background = '#374151';

    if (type === 'success') toast.style.color = 'black';

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Tour Logic
document.addEventListener('DOMContentLoaded', () => {
    // RESTORE POSTURE STATE
    const savedPosture = localStorage.getItem('posture-check');
    if (savedPosture === 'true') {
        const toggle = document.getElementById('posture-toggle');
        if (toggle) toggle.checked = true;
    }

    const hasSeenTour = localStorage.getItem('hasSeenTour_v1');

    if (!hasSeenTour) {
        const driver = window.driver.js.driver;

        const driverObj = driver({
            showProgress: true,
            steps: [
                { popover: { title: 'Welcome to CareerDev AI! üöÄ', description: 'Let\'s take a quick tour of your new career hub.' } },
                { element: '#tour-security', popover: { title: 'Security First', description: 'Monitor your account status and manage credentials here.' } },
                { element: '#tour-a11y', popover: { title: 'Universal Accessibility', description: 'Our dedicated panel to adapt the platform to your needs (Vision, Hearing, Motor).' } },
                { element: '#chatbot-toggle', popover: { title: 'AI Assistant', description: 'Need study tips or interview simulation? Call our AI here.' } },
                { element: '.badges-hall', popover: { title: 'Your Achievements', description: 'Complete tasks and earn badges to share on LinkedIn!' } }
            ],
            onDestroyed: () => {
                localStorage.setItem('hasSeenTour_v1', 'true');
            }
        });

        driverObj.drive();
    }
});

// Badge Logic
let currentBadgeName = "";

function openBadgeModal(name, desc, icon) {
    currentBadgeName = name;
    document.getElementById('badge-name-display').innerText = name;
    document.getElementById('badge-desc-display').innerText = desc;
    document.getElementById('badge-icon-display').innerText = icon;
    document.getElementById('badge-modal').style.display = 'flex';
}

function shareBadge(platform) {
    const text = `I just earned the badge "${currentBadgeName}" on CareerDev AI! üöÄ Accelerating my tech career with AI. #CareerDevAI #TechCareer`;
    let url = "";

    if (platform === 'linkedin') {
        url = `https://www.linkedin.com/feed/?shareActive=true&text=${encodeURIComponent(text)}`;
    } else if (platform === 'twitter') {
        url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
    }

    window.open(url, '_blank', 'width=600,height=400');
}

async function analyzeResume() {
    const text = document.getElementById('resume-text').value;
    if (!text) return alert("Please paste the resume text.");

    const btn = document.querySelector('#resume-modal .btn');
    btn.disabled = true;
    btn.innerText = "Analyzing...";

    const formData = new FormData();
    formData.append('resume_text', text);

    try {
        const res = await fetch('/career/analyze-resume', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();

        document.getElementById('resume-result').style.display = 'block';
        document.getElementById('res-score').innerText = `Score: ${data.score}/100`;
        document.getElementById('res-feedback').innerText = data.feedback;

        const gapsList = document.getElementById('res-gaps');
        gapsList.innerHTML = "<strong>Gaps Added to Plan:</strong><br>" +
            (data.added_plans.length ? data.added_plans.join(", ") : "No critical gaps found.");

        btn.innerText = "Done!";
        setTimeout(() => location.reload(), 3000); // Reload to show new plans

    } catch (e) {
        alert("Analysis error.");
        btn.disabled = false;
        btn.innerText = "Analyze";
    }
}
</script>
{% endblock %}
