{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="career-os-wrapper">

    <!-- ZONE A: CAREER COMMAND CENTER (CENTER) -->
    <main class="career-main">

        <!-- IDENTITY HEADER -->
        <div class="os-header card">
            <div class="identity-flex">
                <div class="identity-info">
                    <h1 class="glitch-text" data-text="STATUS: ONLINE">STATUS: ONLINE</h1>
                    <p class="user-handle">OPERATOR: {{ user.name or email }} <span class="badge-level">LVL {{ profile.level }}</span></p>
                    <div class="stat-line">
                        <span>FOCUS: <span class="highlight-cyan">{{ profile.focus }}</span></span>
                        <span>TOKENS: <span class="highlight-gold">{% if user.is_premium %}UNLIMITED{% else %}10/100{% endif %}</span></span>
                    </div>
                </div>
                <!-- BADGES MINI -->
                <div class="badges-mini">
                    {% if badges %}
                        {% for ub in badges[:4] %}
                        <span class="mini-badge" title="{{ ub.badge.name }}">{{ ub.badge.icon }}</span>
                        {% endfor %}
                        {% if badges|length > 4 %}<span class="more-badges">+{{ badges|length - 4 }}</span>{% endif %}
                    {% else %}
                        <span class="text-muted">No badges yet.</span>
                    {% endif %}
                </div>
            </div>
            <div class="xp-bar-container">
                <div class="xp-bar" style="width: 78%;"></div>
            </div>
        </div>

        <!-- WIDGET C: MARKET PULSE (MARKET_FEED) -->
        <div class="market-ticker-bar">
            <span class="ticker-label">MARKET_FEED >></span>
            <div class="ticker-content" id="market-ticker-content">
                <!-- JS Injected -->
            </div>
        </div>

        <!-- DASHBOARD GRID -->
        <div class="os-grid">

            <!-- WIDGET A: SKILLS RADAR -->
            <div class="card market-radar-card">
                <h3><span class="icon">üì°</span> SKILLS RADAR</h3>
                <div class="chart-container">
                    <canvas id="marketRadarChart"></canvas>
                </div>
            </div>

            <!-- GAP ANALYSIS -->
            <div class="card gap-analysis-card">
                <h3><span class="icon">‚ö†Ô∏è</span> DETECTED GAPS</h3>
                <div class="gap-list" id="gap-list-container">
                    <!-- JS Injected -->
                </div>
                <button class="btn-scan" onclick="document.getElementById('resume-modal').style.display='flex'">
                    SCAN RESUME_DATA
                </button>
            </div>

        </div>

        <!-- WIDGET B: CURRENT UPSKILLING SPRINT (Roadmap) -->
        <div class="card upskilling-engine">
            <div class="card-header-flex">
                <h3><span class="icon">üìÖ</span> CURRENT UPSKILLING SPRINT</h3>
                <div class="kanban-controls">
                    <span class="active">KANBAN_VIEW</span>
                </div>
            </div>

            <div class="roadmap-container" id="roadmap-container">
                <!-- JS Injected -->
            </div>
        </div>

    </main>

    <!-- ZONE B: MENTOR & NETWORK (RIGHT) -->
    <aside class="assistant-zone">

        <!-- CHATBOT CONSOLE -->
        <div class="embedded-chat-container">
            <div class="chat-terminal-header">
                <span>AI_MENTOR_V2.0</span>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button id="dashboard-interview-toggle" style="border: 1px solid var(--neon-cyan); background: transparent; color: var(--neon-cyan); font-family: 'Courier New'; cursor: pointer; font-size: 0.7rem; padding: 2px 8px;">START_SIMULATION</button>
                    <span id="interview-status-indicator" style="font-size: 0.7em; color: #6b7280;">READY</span>
                </div>
            </div>
            <!-- The Chatbot JS will target this container -->
            <div id="embedded-chatbot-target" style="height: 100%; display: flex; flex-direction: column;">
                <!-- Placeholder for injection -->
                <div style="padding: 20px; color: #6b7280; text-align: center;">Initializing Neural Link...</div>
            </div>
        </div>

        <!-- NETWORKING NODE (Moved) -->
        <div class="card networking-node">
            <h3><span class="icon">üåê</span> NETWORKING_NODE</h3>
            <div class="network-grid">
                <a href="https://discord.gg/rust-lang" target="_blank" class="net-link">
                    <span class="net-icon">üëæ</span> RUST_DISCORD
                </a>
                <a href="https://gophers.slack.com/" target="_blank" class="net-link">
                    <span class="net-icon">üêπ</span> GOPHERS_SLACK
                </a>
                 <a href="#" class="net-link">
                    <span class="net-icon">üß†</span> AI_ETHICS_FORUM
                </a>
            </div>
        </div>

    </aside>

</div>

<!-- MODALS (Hidden) -->
<div id="badge-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 400px; background: #0f172a; border: 1px solid var(--secondary-color); text-align: center;">
        <div id="badge-icon-display" style="font-size: 4rem; margin-bottom: 10px;">üèÜ</div>
        <h3 id="badge-name-display" style="margin: 0; color: var(--secondary-color);">Badge Name</h3>
        <p id="badge-desc-display" style="color: #cbd5e1; font-size: 0.9rem; margin: 10px 0;">Description</p>
        <div style="margin-top: 20px; display: grid; gap: 10px;">
            <button onclick="shareBadge('linkedin')" class="btn-action">Share on LinkedIn</button>
            <button onclick="shareBadge('twitter')" class="btn-action">Share on X</button>
        </div>
        <button onclick="document.getElementById('badge-modal').style.display='none'" class="btn-outline" style="margin-top: 15px; width: 100%;">Close</button>
    </div>
</div>

<div id="resume-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 600px; background: #0f172a; border: 1px solid var(--primary-color);">
        <h3 style="margin-top: 0; color: var(--primary-color);">ü§ñ Smart Resume Analysis</h3>
        <p style="font-size: 0.9rem; color: #cbd5e1;">Paste your resume text below.</p>
        <textarea id="resume-text" rows="10" style="width: 100%; background: #1e293b; color: white; border: 1px solid #334155; border-radius: 6px; padding: 10px;" placeholder="Paste your CV here..."></textarea>
        <div id="resume-result" style="display: none; margin-top: 15px; padding: 10px; background: rgba(0, 255, 136, 0.1); border-radius: 6px;">
            <h4 id="res-score" style="margin: 0; color: var(--secondary-color);">Score: 0/100</h4>
            <p id="res-feedback" style="font-size: 0.9rem;"></p>
            <ul id="res-gaps" style="font-size: 0.85rem; color: #fbbf24;"></ul>
        </div>
        <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
            <button onclick="document.getElementById('resume-modal').style.display='none'" class="btn-outline">Close</button>
            <button onclick="analyzeResume()" class="btn">Analyze</button>
        </div>
    </div>
</div>

<!-- PiP Container (Draggable) - Preserved -->
<div id="pip-container" style="display: none;">
    <div id="pip-container-header">
        <span style="font-size: 0.8rem; font-weight: bold;">Posture AI</span>
        <button onclick="HealthModule.stopPostureCheck()" style="background: none; border: none; color: white; cursor: pointer;">‚úï</button>
    </div>
    <video id="pip-video" playsinline muted style="width: 100%; height: 100%; object-fit: cover;"></video>
</div>

<!-- STYLES -->
<style>
    /* VARIABLES */
    :root {
        --cyber-black: #050a14;
        --cyber-dark: #0f172a;
        --cyber-gray: #1e293b;
        --neon-cyan: #00f3ff;
        --neon-green: #00ff88;
        --neon-purple: #bd00ff;
        --text-main: #e2e8f0;
        --text-muted: #94a3b8;
    }

    /* GLOBAL OVERRIDES FOR DASHBOARD */
    .dashboard-content-area {
        padding: 0 !important;
        max-width: none !important;
        height: 100%;
    }

    /* LAYOUT GRID */
    .career-os-wrapper {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 20px;
        height: calc(100vh - 120px); /* Adjust for header/footer */
        overflow: hidden; /* Main scroll handling */
    }

    @media (max-width: 1200px) {
        .career-os-wrapper {
            grid-template-columns: 1fr;
            height: auto;
            overflow: visible;
        }
        .assistant-zone {
            height: auto;
        }
        .embedded-chat-container {
            height: 500px; /* Fixed height on mobile */
        }
    }

    /* MAIN COLUMN */
    .career-main {
        overflow-y: auto;
        padding-right: 10px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* ASSISTANT COLUMN */
    .assistant-zone {
        display: flex;
        flex-direction: column;
        gap: 20px;
        height: 100%;
    }

    /* CARDS GENERIC */
    .card {
        background: var(--cyber-dark);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .card h3 {
        margin: 0 0 15px 0;
        font-family: 'Courier New', monospace;
        color: var(--neon-cyan);
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.1rem;
    }

    /* HEADER */
    .os-header {
        border-left: 4px solid var(--neon-cyan);
        background: linear-gradient(90deg, rgba(15,23,42,1) 0%, rgba(5,10,20,1) 100%);
    }
    .identity-flex {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    .glitch-text {
        font-family: 'Courier New', monospace;
        font-size: 1.5rem;
        margin: 0;
        color: var(--neon-green);
        text-shadow: 0 0 5px rgba(0,255,136,0.5);
    }
    .user-handle {
        margin: 5px 0;
        color: var(--text-main);
        font-size: 1.1rem;
    }
    .badge-level {
        background: var(--neon-purple);
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        color: white;
        margin-left: 10px;
    }
    .stat-line {
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 5px;
        display: flex;
        gap: 20px;
    }
    .highlight-cyan { color: var(--neon-cyan); }
    .highlight-gold { color: gold; }
    .xp-bar-container {
        margin-top: 15px;
        background: rgba(255,255,255,0.1);
        height: 4px;
        border-radius: 2px;
    }
    .xp-bar {
        background: var(--neon-cyan);
        height: 100%;
        box-shadow: 0 0 10px var(--neon-cyan);
    }

    /* MARKET TICKER */
    .market-ticker-bar {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 4px;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
        overflow: hidden;
    }
    .ticker-label {
        font-family: 'Courier New', monospace;
        color: var(--neon-cyan);
        font-weight: bold;
        white-space: nowrap;
        font-size: 0.8rem;
    }
    .ticker-content {
        display: flex;
        gap: 40px;
        animation: marquee 20s linear infinite;
        white-space: nowrap;
    }
    .ticker-item {
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        color: #e2e8f0;
    }
    .trend-positive { color: var(--neon-green); }
    .trend-negative { color: var(--error-color); }

    @keyframes marquee {
        0% { transform: translateX(50%); }
        100% { transform: translateX(-100%); }
    }

    /* OS GRID (Radar + Gap) */
    .os-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    @media (max-width: 900px) { .os-grid { grid-template-columns: 1fr; } }

    .gap-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .gap-item {
        background: rgba(255, 0, 85, 0.1);
        border-left: 3px solid var(--error-color);
        padding: 10px;
        font-size: 0.9rem;
    }
    .gap-item strong { display: block; color: #ff8fa3; }
    .btn-scan {
        margin-top: 15px;
        width: 100%;
        background: transparent;
        border: 1px solid var(--neon-cyan);
        color: var(--neon-cyan);
        padding: 10px;
        font-family: 'Courier New', monospace;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-scan:hover { background: rgba(0,243,255,0.1); }

    /* UPSKILLING */
    .card-header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .kanban-controls span {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-left: 10px;
        cursor: pointer;
    }
    .kanban-controls span.active { color: var(--neon-cyan); text-decoration: underline; }

    .roadmap-item {
        display: flex;
        gap: 15px;
        background: rgba(255,255,255,0.03);
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 10px;
        border-left: 3px solid var(--text-muted);
        transition: transform 0.2s;
    }
    .roadmap-item:hover { transform: translateX(5px); }
    .roadmap-item.high-prio { border-color: var(--neon-green); }
    .roadmap-week {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        color: var(--text-muted);
        min-width: 60px;
    }
    .roadmap-content h4 { margin: 0; color: var(--text-main); }
    .roadmap-content p { margin: 5px 0 0 0; font-size: 0.85rem; color: #94a3b8; }

    /* EMBEDDED CHAT */
    .embedded-chat-container {
        flex-grow: 1;
        background: #000;
        border: 1px solid var(--neon-cyan);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .chat-terminal-header {
        background: rgba(0, 243, 255, 0.1);
        padding: 8px 15px;
        border-bottom: 1px solid rgba(0, 243, 255, 0.3);
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        color: var(--neon-cyan);
        display: flex;
        justify-content: space-between;
    }

    /* NETWORK GRID */
    .network-grid { display: flex; gap: 10px; flex-wrap: wrap; }
    .net-link {
        background: rgba(255,255,255,0.05);
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 0.85rem;
        color: var(--text-main);
        border: 1px solid transparent;
        transition: all 0.2s;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .net-link:hover { border-color: var(--neon-cyan); background: rgba(0,243,255,0.1); }
</style>

<!-- JS LOGIC -->
<script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
<script>
    // --- TOAST UTILITY ---
    window.showToast = function(msg, type) {
        const toast = document.createElement('div');
        toast.innerText = msg;
        toast.style.position = 'fixed';
        toast.style.bottom = '20px';
        toast.style.right = '20px';
        toast.style.padding = '15px 25px';
        toast.style.borderRadius = '8px';
        toast.style.color = 'white';
        toast.style.zIndex = '10000';
        toast.style.fontWeight = 'bold';
        toast.style.boxShadow = '0 4px 6px rgba(0,0,0,0.3)';
        toast.style.animation = 'slideIn 0.3s ease-out';
        toast.style.background = (type === 'warning' || type === 'error') ? '#ff0055' :
                                 (type === 'success') ? '#00ff88' : '#374151';
        if (type === 'success') toast.style.color = 'black';

        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    };

    // --- CONFIG ---
    window.CAREER_OS_EMBEDDED_CHAT = true;

    // --- MOCK DATA FOR CHART.JS ---
    // Injected from Backend
    const CAREER_DATA = {{ career_data | tojson }};
    const PROFILE_DATA = {{ profile | tojson }};

    // Use injected radar data if available, otherwise fallback (or fail, but we expect data)
    const MARKET_DATA = CAREER_DATA.radar_data || {
        labels: ['Rust', 'Go', 'Python', 'AI/ML', 'System Design', 'React'],
        datasets: [{
            label: 'Your Skills',
            data: [40, 30, 90, 60, 50, 80],
            backgroundColor: 'rgba(0, 243, 255, 0.2)',
            borderColor: '#00f3ff',
            pointBackgroundColor: '#00f3ff',
        }, {
            label: 'Market Demand',
            data: [90, 85, 80, 95, 85, 70],
            backgroundColor: 'rgba(255, 255, 255, 0.05)',
            borderColor: '#6b7280',
            borderDash: [5, 5],
            pointBackgroundColor: 'transparent'
        }]
    };

    // --- INITIALIZATION ---
    document.addEventListener("DOMContentLoaded", () => {
        // 1. Render Radar Chart (Widget A)
        try {
            if (typeof Chart !== 'undefined') {
                const ctx = document.getElementById('marketRadarChart').getContext('2d');
                new Chart(ctx, {
                    type: 'radar',
                    data: MARKET_DATA,
                    options: {
                        scales: {
                            r: {
                                angleLines: { color: 'rgba(255,255,255,0.1)' },
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                pointLabels: { color: '#94a3b8', font: { family: 'Courier New' } },
                                ticks: { display: false, backdropColor: 'transparent' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#e2e8f0' } }
                        }
                    }
                });
            } else {
                console.warn("Chart.js not loaded. Radar chart skipped.");
            }
        } catch (e) {
            console.error("Radar Chart Error:", e);
        }

        // 2. Render Gaps (Using career_data)
        const gapContainer = document.getElementById('gap-list-container');
        CAREER_DATA.skill_gap.forEach(gap => {
            const div = document.createElement('div');
            div.className = 'gap-item';
            div.innerHTML = `<strong>${gap}</strong> <span style="float:right; font-size:0.7em; background:#374151; padding:2px 6px; border-radius:4px;">Critical</span>`;
            gapContainer.appendChild(div);
        });

        // 3. Render Current Upskilling Sprint (Widget B)
        const roadContainer = document.getElementById('roadmap-container');
        CAREER_DATA.weekly_plan.forEach(item => {
            const div = document.createElement('div');
            div.className = `roadmap-item ${item.status === 'completed' ? '' : 'high-prio'}`;
            div.innerHTML = `
                <div class="roadmap-week">${item.day}</div>
                <div class="roadmap-content">
                    <h4>${item.task}</h4>
                    <p>Status: ${item.status}</p>
                </div>
            `;
            roadContainer.appendChild(div);
        });

        // 4. Render Market Pulse (Widget C)
        const tickerContainer = document.getElementById('market-ticker-content');
        const trends = CAREER_DATA.market_trends; // Object { "Edge AI": "High Demand", ... }

        for (const [tech, val] of Object.entries(trends)) {
            const span = document.createElement('span');
            span.className = 'ticker-item';

            let trendClass = '';
            if (val.includes('+')) trendClass = 'trend-positive';
            if (val.includes('-')) trendClass = 'trend-negative';
            if (val.toLowerCase().includes('high demand')) trendClass = 'trend-positive'; // Custom logic for new data
            if (val.toLowerCase().includes('low demand')) trendClass = 'trend-negative'; // Custom logic

            span.innerHTML = `${tech.toUpperCase()}: <span class="${trendClass}">${val}</span>`;
            tickerContainer.appendChild(span);
        }

        // 5. Hide Global Chatbot Floating Widget (if present)
        const globalChat = document.getElementById('chatbot-widget');
        const globalToggle = document.getElementById('chatbot-toggle');
        if(globalChat) globalChat.style.display = 'none';
        if(globalToggle) globalToggle.style.display = 'none';

        // Note: HealthModule.init() is now called in layout (or handled via health.js script load if it auto-runs)
        if (window.HealthModule) HealthModule.init();
    });

    // Badge Share Mock
    let currentBadgeName = "";
    function openBadgeModal(name, desc, icon) {
        currentBadgeName = name;
        document.getElementById('badge-name-display').innerText = name;
        document.getElementById('badge-desc-display').innerText = desc;
        document.getElementById('badge-icon-display').innerText = icon;
        document.getElementById('badge-modal').style.display = 'flex';
    }
    function shareBadge(platform) {
        const text = `I just earned the badge "${currentBadgeName}" on CareerDev AI!`;
        alert(`Simulating share to ${platform}: ${text}`);
    }

    // Resume Logic Stub
    function analyzeResume() {
        const btn = document.querySelector('#resume-modal .btn');
        btn.innerText = "Scanning...";
        setTimeout(() => {
             document.getElementById('resume-result').style.display = 'block';
             document.getElementById('res-score').innerText = "Score: 78/100";
             document.getElementById('res-feedback').innerText = "Good Python experience. Lack of statically typed languages detected.";
             document.getElementById('res-gaps').innerHTML = "<li>Recommended: Rust Basics</li><li>Recommended: Go Concurrency</li>";
             btn.innerText = "Done";
        }, 1500);
    }
</script>
{% endblock %}
