{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* NUCLEAR CSS RESET */
    .dashboard-sidebar, .main-header, .navbar, .footer, #sidebar-wrapper { display: none !important; }
    .content-wrapper, .main-panel, .dashboard-content {
        margin: 0 !important; padding: 0 !important; width: 100vw !important; height: 100vh !important;
        position: fixed !important; top: 0 !important; left: 0 !important; z-index: 9900 !important;
        background: #050505 !important;
    }

    /* THEME */
    :root {
        --bg-deep: #050505; --bg-panel: #0f111a; --border: rgba(255, 255, 255, 0.08);
        --neon-blue: #3b82f6; --neon-green: #10b981; --neon-purple: #8b5cf6; --alert: #ef4444;
        --text-main: #f3f4f6; --text-dim: #9ca3af; --font-mono: 'JetBrains Mono', monospace;
    }
    body { background-color: var(--bg-deep) !important; color: var(--text-main); font-family: 'Inter', sans-serif; overflow: hidden; }

    /* LAYOUT */
    .grid-layout {
        display: grid; grid-template-columns: 80px 1fr 350px; grid-template-rows: 60px 1fr 30px;
        height: 100vh; width: 100vw; gap: 12px; padding: 12px; box-sizing: border-box;
    }

    /* PANELS */
    .panel { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
    .panel-head { padding: 12px 16px; background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border); font-family: var(--font-mono); font-size: 0.75rem; font-weight: 700; color: var(--neon-blue); display: flex; justify-content: space-between; }

    /* NAVIGATION */
    .nav-dock { grid-row: 1 / 4; display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 20px; }
    .nav-btn {
        width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
        color: var(--text-dim); border: 1px solid transparent; font-size: 1.4rem; cursor: pointer; text-decoration: none; transition: 0.3s;
    }
    .nav-btn:hover, .nav-btn.active { background: rgba(59, 130, 246, 0.15); color: var(--neon-blue); border-color: var(--neon-blue); }

    /* HEALTH MODULE */
    .bio-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 12px; }
    .bio-card { background: #000; border: 1px solid var(--border); border-radius: 6px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
    .bio-card.active { border-color: var(--neon-green); background: rgba(16, 185, 129, 0.1); }
    .bio-label { font-size: 0.6rem; font-family: var(--font-mono); color: var(--text-dim); text-transform: uppercase; display: block; margin-top: 5px; }
    .bio-card.active .bio-label { color: var(--neon-green); }

    /* --- 9. SMART LOADER --- */
    .smart-loader {
        position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9);
        display: none; justify-content: center; align-items: center; z-index: 10000; flex-direction: column;
    }
    .loader-text { font-family: var(--font-mono); color: var(--neon-green); margin-top: 20px; font-size: 0.9rem; }

    /* --- 10. TABS & STREAK --- */
    .tab-container { display: flex; gap: 10px; border-bottom: 1px solid var(--border); padding: 0 10px; margin-bottom: 0px; background: rgba(0,0,0,0.2); }
    .tab-btn {
        background: transparent; border: none; color: var(--text-dim);
        padding: 10px; font-family: var(--font-mono); font-size: 0.75rem;
        cursor: pointer; border-bottom: 2px solid transparent;
        transition: 0.3s;
    }
    .tab-btn.active { color: var(--neon-blue); border-bottom-color: var(--neon-blue); }
    .tab-btn:hover { color: #fff; }

    .streak-container { display: flex; gap: 4px; align-items: center; }
    .streak-square { width: 8px; height: 8px; border-radius: 1px; background: #333; transition: 0.3s; }
    .streak-square.active { background: var(--neon-green); box-shadow: 0 0 5px var(--neon-green); }
    .streak-square.hardcore { background: #ff4500; box-shadow: 0 0 8px #ff4500; }

    /* LOADER */
    .loader-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:var(--bg-panel); display:flex; justify-content:center; align-items:center; z-index:10; }
</style>

<div class="grid-layout">
    
    <nav class="panel nav-dock">
        <div style="font-weight: 900; color: #fff; font-size: 1.2rem; margin-bottom: 10px;">C/AI</div>

        <a href="/dashboard" class="nav-btn active" title="Command Center">‚åò</a>

        <a href="/dashboard/ai-settings" class="nav-btn" title="AI Configuration">üß†</a>

        <a href="/dashboard/network" class="nav-btn" title="Network Node">üåê</a>

        <a href="/dashboard/security" class="nav-btn" title="Security & Privacy">üõ°Ô∏è</a>

        <a href="/legal" class="nav-btn" title="Legal Info">‚öñÔ∏è</a>

        <div style="flex-grow: 1;"></div>
        <a href="/logout" class="nav-btn" style="color: var(--alert);" title="Logout">‚úï</a>
    </nav>

    <div class="panel" style="grid-column: 2/4; flex-direction: row; align-items: center; padding: 0 20px;">
        <span style="font-family: var(--font-mono); color: var(--neon-blue); margin-right: 20px;">REAL_TIME_FEED ::</span>
        <marquee style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--neon-green);">
            SYSTEM CONNECTED TO GITHUB & LINKEDIN API... ANALYZING SKILL GAPS... MARKET DEMAND: RUST +20%...
        </marquee>
    </div>

    <main class="panel" style="grid-column: 2/3; grid-row: 2/3;">
        <div class="panel-head">
            <span>DATA FUSION: REALITY vs MARKET</span>
            <div style="display: flex; align-items: center; gap: 15px;">
                 <div class="streak-container" id="streak-widget"></div>
                 <span style="opacity: 0.5;">{{ user.email }}</span>
            </div>
        </div>

        <div class="tab-container">
            <button class="tab-btn active" id="tab-audit" onclick="switchTab('audit')">AUDIT VIEW</button>
            <button class="tab-btn" id="tab-growth" onclick="switchTab('growth')">WEEKLY PLAN</button>
        </div>

        <div style="overflow-y: auto; flex-grow: 1; position: relative;">
            <div id="view-audit" style="display: block;"></div>
            <div id="view-growth" style="display: none; padding: 10px;"></div>
            <div class="loader-overlay" id="data-loader">
                <span style="font-family: var(--font-mono); color: var(--neon-blue);">CONNECTING TO NEURAL ENGINE...</span>
            </div>
        </div>

        <div style="height: 160px; border-top: 1px solid var(--border); padding: 15px; display: flex; align-items: center; gap: 20px;">
            <div style="width: 140px; height: 140px;"><canvas id="radarChart"></canvas></div>
            <div>
                <div style="color: var(--text-dim); font-size: 0.8rem; font-family: var(--font-mono);">MARKET ALIGNMENT</div>
                <div style="font-size: 2rem; font-weight: 800; color: var(--neon-green);" id="market-score">--/100</div>
                <button onclick="triggerGenerator()" style="background: var(--neon-purple); border: none; color: white; padding: 5px 10px; font-family: var(--font-mono); font-size: 0.7rem; cursor: pointer; margin-top: 5px;">GENERATE MICRO-PROJECT</button>
            </div>
        </div>
    </main>

    <aside style="grid-column: 3/4; grid-row: 2/3; display: flex; flex-direction: column; gap: 12px;">

        <div class="panel">
            <div class="panel-head">BIO_MONITOR</div>
            <div class="bio-grid">
                <div class="bio-card" onclick="toggleBio(this)"><span class="bio-icon">ü¶¥</span><span class="bio-label">Posture</span></div>
                <div class="bio-card" onclick="toggleBio(this)"><span class="bio-icon">üëÅÔ∏è</span><span class="bio-label">Vision</span></div>
                <div class="bio-card" onclick="toggleBio(this)"><span class="bio-icon">üíß</span><span class="bio-label">Hydration</span></div>
            </div>
        </div>

        <div class="panel" style="flex-grow: 1; background: #000;">
            <div class="panel-head" style="border-color: var(--neon-purple); color: var(--neon-purple);">AI_MENTOR</div>
            <div id="chat-history" style="flex-grow: 1; padding: 15px; color: var(--text-dim); overflow-y: auto; font-family: var(--font-mono); font-size: 0.8rem;">
                <div>> System Ready.</div>
            </div>
            <input type="text" id="chat-input" placeholder="Ask Mentor..." style="width: 100%; background: #111; border: none; border-top: 1px solid var(--border); padding: 12px; color: #fff; font-family: var(--font-mono); outline: none;">
        </div>
    </aside>

    <footer class="footer-bar" style="grid-column: 2/4;">
        <span>STATUS: ONLINE</span>
        <span style="color: var(--text-dim); font-size: 0.7rem;">CAREERDEV AI v2.0</span>
    </footer>
</div>

<script>
    // --- 0. INJECTED CONSTANTS ---
    const USER_ID = {{ user.id }};
    const USER_STREAK = {{ user.weekly_streak_count or 0 }};

    // --- 1. DATA FETCH & RENDER ---
    async function initDashboard() {
        renderStreak(USER_STREAK);
        try {
            // Call the REAL backend endpoint
            const response = await fetch('/api/dashboard/stats');
            const data = await response.json();

            // Hide Loader
            document.getElementById('data-loader').style.display = 'none';

            renderZoneB(data.zone_b_matrix);

            if (data.weekly_plan) {
                renderWeeklyPlan(data.weekly_plan);
            } else {
                document.getElementById('view-growth').innerHTML = '<div style="padding:20px; text-align:center; color:#666;">PLAN GENERATING... REFRESH IN 5s</div>';
            }

            renderRadar(data.zone_a_reality); // Use correct key from backend

            // Update Score
            if (data.zone_c_ticker) {
                 document.getElementById('market-score').innerText = data.zone_c_ticker.user_score + "/100";
            }

            // Context Injection
            if (data.missing_skills && data.missing_skills.length > 0) {
                 window.USER_CONTEXT_MISSING_SKILLS = data.missing_skills;
            }

        } catch (e) {
            console.error("Dashboard Load Error:", e);
            runSimulation(); // Fallback
        }
    }

    function switchTab(tab) {
        document.getElementById('view-audit').style.display = tab === 'audit' ? 'block' : 'none';
        document.getElementById('view-growth').style.display = tab === 'growth' ? 'block' : 'none';

        document.getElementById('tab-audit').className = tab === 'audit' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tab-growth').className = tab === 'growth' ? 'tab-btn active' : 'tab-btn';
    }

    function renderStreak(streak) {
        const container = document.getElementById('streak-widget');
        let html = '';
        const totalSquares = Math.max(streak + 2, 4);

        for (let i = 0; i < totalSquares; i++) {
            let className = 'streak-square';
            if (i < streak) {
                className += (streak >= 4) ? ' hardcore' : ' active';
            }
            html += `<div class="${className}" title="Week ${i+1}"></div>`;
        }

        if (streak >= 4) {
             html += `<span style="margin-left:5px; font-size:10px;">üî• HARDCORE</span>`;
        }

        container.innerHTML = html;
    }

    function renderWeeklyPlan(plan) {
        const container = document.getElementById('view-growth');
        if (!plan) return;

        let html = `<div style="padding:10px; border-bottom:1px solid var(--border); margin-bottom:10px;">
            <div style="color:var(--neon-green); font-size:0.8rem; font-weight:bold;">FOCUS: ${plan.focus_language}</div>
            <div style="font-size:0.7rem; color:var(--text-dim);">${plan.reasoning}</div>
        </div>`;

        html += `<div style="display:flex; flex-direction:column; gap:10px;">`;

        plan.routine.forEach(task => {
            const isDone = task.status === 'completed';
            const statusColor = isDone ? 'var(--neon-green)' : '#666';
            const icon = isDone ? '‚úÖ' : '‚¨ú';

            let actionBtn = '';
            if (!isDone && task.verify_url) {
                actionBtn = `<button onclick="verifyTask(${task.id}, '${task.target_skill}')"
                    style="margin-top:5px; width:100%; background:rgba(16,185,129,0.1); border:1px solid var(--neon-green); color:var(--neon-green); padding:5px; font-family:var(--font-mono); font-size:0.7rem; cursor:pointer; border-radius:4px; text-transform:uppercase;">
                    VERIFY CODE
                </button>`;
            }

            html += `
            <div style="background:rgba(255,255,255,0.03); padding:10px; border-radius:4px; border-left:3px solid ${statusColor};">
                <div style="display:flex; justify-content:space-between;">
                    <span style="font-weight:bold; font-size:0.8rem; color:#fff;">${task.day}: ${task.type}</span>
                    <span>${icon}</span>
                </div>
                <div style="font-size:0.75rem; color:#ccc; margin-top:5px;">${task.task}</div>
                ${actionBtn}
            </div>`;
        });

        html += `</div>`;
        container.innerHTML = html;
    }

    async function verifyTask(taskId, targetSkill) {
        // Mock verification for now or implement real fetch
        addToChat(`SCANNING GITHUB FOR ${targetSkill}...`);
        setTimeout(() => {
             addToChat("VERIFICATION COMPLETE. STREAK UPDATED.");
             // Real app would fetch /api/growth/verify here
        }, 2000);
    }

    function renderZoneB(matrix) {
        const container = document.getElementById('view-audit');
        container.innerHTML = '';
        if(!matrix) return;
        
        matrix.forEach(item => {
            const div = document.createElement('div');
            div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.padding = '10px'; div.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
            div.innerHTML = `
                <div style="width: 120px; font-weight: 600; font-size: 0.9rem; color:${item.color || '#fff'}">${item.skill}</div>
                <div style="flex-grow:1; margin: 0 10px; background:rgba(255,255,255,0.1); height:6px; border-radius:3px;">
                    <div style="width:${item.percentage || 50}%; height:100%; background:${item.color || '#3b82f6'};"></div>
                </div>
                <div style="width: 120px; text-align: right; font-family: var(--font-mono); font-size: 0.75rem;">
                    ${item.verdict}
                </div>`;
            container.appendChild(div);
        });
    }

    function renderRadar(data) {
        if(!data) return;
        const ctx = document.getElementById('radarChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: data.labels || ['Python', 'Rust', 'Systems', 'Web'],
                datasets: [{
                    label: 'Reality (GH)',
                    data: data.values || [80, 20, 30, 90],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.2)'
                }, {
                    label: 'Market (LI)',
                    data: [80, 90, 80, 50],
                    borderColor: '#10b981',
                    borderDash: [5, 5],
                    fill: false
                }]
            },
            options: { plugins: { legend: { display: false } }, scales: { r: { grid: { color: '#333' }, ticks: { display: false } } } }
        });
    }

    // --- 2. HEALTH BUTTON LOGIC ---
    function toggleBio(el) {
        el.classList.toggle('active');
        const status = el.classList.contains('active') ? "ACTIVATED" : "DEACTIVATED";
        const label = el.querySelector('.bio-label').innerText;
        addToChat(`BIO_SYSTEM: ${label} monitoring ${status}.`);
    }

    // --- 3. GENERATOR LOGIC ---
    function triggerGenerator() {
        addToChat("Initializing Micro-Project Generator...");
        setTimeout(() => addToChat("Analyzing Gaps... Detected: Rust System Design."), 1000);
        setTimeout(() => addToChat("Generating Spec: 'High-Concurrency Chat Server in Rust'..."), 2500);
    }

    function copyBadge() {
        const code = `[![CareerDev Badge](${window.location.origin}/api/badge/${USER_ID})]`;
        navigator.clipboard.writeText(code).then(() => {
            alert("COPIED TO CLIPBOARD!");
        });
    }

    function triggerHotfix(skill) {
        const input = document.getElementById('chat-input');
        input.value = `Help me fix my lack of ${skill} evidence.`;
        input.focus();
    }

    function triggerChallenge() {
        const input = document.getElementById('chat-input');
        input.value = "Test My Weakness";
        if (window.triggerChallenge) {
             window.triggerChallenge();
        } else {
             alert("Voice Challenge not ready.");
        }
    }

    // --- 3. MATRIX EASTER EGG (UPDATED) ---
    const konami = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
    let kIdx = 0;
    let isMatrixActive = false;

    document.addEventListener('keydown', (e) => {
        if(e.key === konami[kIdx]) {
            kIdx++;
            if(kIdx === konami.length) {
                // TOGGLE LOGIC
                isMatrixActive = !isMatrixActive;

                if (isMatrixActive) {
                    document.body.classList.add('theme-matrix');
                    addToChat("Wake up, Neo...");
                } else {
                    document.body.classList.remove('theme-matrix');
                    addToChat("Matrix simulation disabled.");
                }

                kIdx = 0;
            }
        } else { kIdx = 0; }
    });

    // --- 4. UTILS ---
    function addToChat(msg) {
        const chat = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.style.marginBottom = '5px'; div.innerText = `> ${msg}`;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    // FALLBACK SIMULATION (If Backend is cold)
    function runSimulation() {
        document.getElementById('data-loader').style.display = 'none';
        renderZoneB([
            { skill: "Python", percentage: 90, verdict: "MATCH", color: "#3b82f6" },
            { skill: "Rust", percentage: 10, verdict: "CRITICAL GAP", color: "#ef4444" },
            { skill: "Docker", percentage: 40, verdict: "GROWING", color: "#f59e0b" }
        ]);
        renderRadar({});
        document.getElementById('market-score').innerText = "68/100";
    }

    // START
    document.addEventListener("DOMContentLoaded", initDashboard);
</script>
{% endblock %}