{% extends "dashboard_layout.html" %}

{% block dashboard_content %}
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* --- 1. NUCLEAR RESET (MANDATORY) --- */
    .dashboard-sidebar, .main-header, .navbar, .footer, #sidebar-wrapper { display: none !important; }
    .content-wrapper, .main-panel, .dashboard-content {
        margin: 0 !important; padding: 0 !important; width: 100vw !important; height: 100vh !important;
        position: fixed !important; top: 0 !important; left: 0 !important; z-index: 9900 !important;
        background: #050505 !important;
    }

    /* --- 2. THEME ENGINE --- */
    :root {
        --bg-deep: #050505;
        --bg-panel: #0f111a;
        --border: rgba(255, 255, 255, 0.08);
        --neon-blue: #3b82f6;
        --neon-cyan: #06b6d4;
        --neon-green: #10b981;
        --neon-purple: #8b5cf6;
        --alert: #ef4444;
        --text-main: #f3f4f6;
        --text-dim: #9ca3af;
        --font-mono: 'JetBrains Mono', monospace;
    }

    body { background-color: var(--bg-deep) !important; color: var(--text-main); font-family: 'Inter', sans-serif; overflow: hidden; }

    /* MATRIX MODE (Easter Egg) */
    body.theme-matrix {
        background-color: #000 !important;
        font-family: 'Courier New', monospace !important;
    }
    body.theme-matrix * {
        color: #00ff00 !important;
        border-color: #00ff00 !important;
        background: #000 !important;
        font-family: 'Courier New', monospace !important;
    }

    /* --- 3. LAYOUT --- */
    .grid-layout {
        display: grid;
        grid-template-columns: 80px 1fr 350px;
        grid-template-rows: 60px 1fr 30px;
        height: 100vh; width: 100vw;
        gap: 12px; padding: 12px;
        box-sizing: border-box;
    }

    /* --- 4. PANELS --- */
    .panel {
        background: var(--bg-panel);
        border: 1px solid var(--border);
        border-radius: 8px;
        display: flex; flex-direction: column;
        position: relative; overflow: hidden;
        box-shadow: 0 10px 30px -10px rgba(0,0,0,0.8);
    }
    .panel-head {
        padding: 12px 16px; background: rgba(255,255,255,0.02);
        border-bottom: 1px solid var(--border);
        font-family: var(--font-mono); font-size: 0.75rem; font-weight: 700;
        color: var(--neon-blue); text-transform: uppercase;
        display: flex; justify-content: space-between; align-items: center;
    }

    /* --- 5. VISUALIZATIONS --- */
    .data-row {
        display: flex; align-items: center; padding: 12px 16px;
        border-bottom: 1px solid var(--border); transition: background 0.2s;
    }
    .data-row:hover { background: rgba(255,255,255,0.03); }
    .skill-bar-track { flex-grow: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin: 0 15px; }
    .skill-bar-fill { height: 100%; border-radius: 3px; }

    /* Tag Badges */
    .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; margin-left: 5px; }
    .tag-gh { background: rgba(59, 130, 246, 0.2); color: var(--neon-blue); border: 1px solid rgba(59, 130, 246, 0.4); }
    .tag-warn { background: rgba(239, 68, 68, 0.2); color: var(--alert); border: 1px solid rgba(239, 68, 68, 0.4); }

    /* --- 6. SIDEBARS --- */
    .nav-dock { grid-row: 1 / 4; display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 20px; }
    .nav-btn {
        width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
        color: var(--text-dim); font-size: 1.4rem; cursor: pointer; text-decoration: none; transition: 0.3s;
    }
    .nav-btn:hover, .nav-btn.active { color: var(--neon-blue); background: rgba(59, 130, 246, 0.15); }

    /* --- 7. HEALTH CONTROLS --- */
    .bio-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 12px; }
    .bio-card {
        background: #000; border: 1px solid var(--border); border-radius: 6px;
        padding: 10px; text-align: center; cursor: pointer; transition: 0.2s;
    }
    .bio-card.active { border-color: var(--neon-green); background: rgba(16, 185, 129, 0.1); }
    .bio-card.active .bio-label { color: var(--neon-green); }
    .bio-label { font-size: 0.6rem; font-family: var(--font-mono); color: var(--text-dim); text-transform: uppercase; display: block; margin-top: 5px;}
    .bio-icon { font-size: 1.2rem; }

    /* --- 8. PRO SUITE BUTTONS --- */
    .btn-cyber {
        background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--neon-cyan);
        width: 100%; padding: 10px; font-family: var(--font-mono); font-size: 0.75rem; cursor: pointer;
        margin-bottom: 8px; border-radius: 4px; transition: 0.2s; text-align: left;
    }
    .btn-cyber:hover { background: rgba(6, 182, 212, 0.15); border-color: var(--neon-cyan); }

    /* --- 9. SMART LOADER --- */
    .smart-loader {
        position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9);
        display: none; justify-content: center; align-items: center; z-index: 10000; flex-direction: column;
    }
    .loader-text { font-family: var(--font-mono); color: var(--neon-green); margin-top: 20px; font-size: 0.9rem; }
</style>

<div class="smart-loader" id="global-loader">
    <div style="width: 50px; height: 50px; border: 3px solid var(--neon-green); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <div class="loader-text" id="loader-msg">INITIALIZING...</div>
    <style>@keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }</style>
</div>

<div class="grid-layout">
    
    <nav class="panel nav-dock">
        <div style="font-weight: 900; color: #fff; font-size: 1.2rem; margin-bottom: 10px;">C/AI</div>
        <a href="#" class="nav-btn active">‚åò</a>
        <a href="#" class="nav-btn">üß†</a>
        <a href="#" class="nav-btn">üåê</a>
        <div style="flex-grow: 1;"></div>
        <a href="/logout" class="nav-btn" style="color: var(--alert);">‚úï</a>
    </nav>

    <div class="panel" style="grid-column: 2/4; flex-direction: row; align-items: center; padding: 0 20px;">
        <span style="font-family: var(--font-mono); color: var(--neon-blue); margin-right: 20px;">LIVE_FEED ::</span>
        <marquee style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--neon-green);">
            GITHUB API: CONNECTED [LATENCY 12ms] /// LINKEDIN TRENDS: RUST +15%, TYPESCRIPT +8% /// SYSTEM: OPTIMAL
        </marquee>
    </div>

    <main class="panel" style="grid-column: 2/3; grid-row: 2/3;">
        <div class="panel-head">
            <span>DATA FUSION: REALITY vs MARKET</span>
            <span style="opacity: 0.5;">{{ user.email }}</span>
        </div>

        <div style="overflow-y: auto; flex-grow: 1;" id="data-container"></div>

        <div style="height: 140px; border-top: 1px solid var(--border); padding: 15px; display: flex; align-items: center; gap: 20px;">
            <div style="width: 100px; height: 100px;"><canvas id="miniChart"></canvas></div>
            <div>
                <div style="color: var(--text-dim); font-size: 0.8rem; font-family: var(--font-mono);">MARKET SCORE</div>
                <div style="font-size: 2.5rem; font-weight: 800; color: var(--neon-green);">87<span style="font-size: 1rem;">/100</span></div>
            </div>
        </div>
    </main>

    <aside style="grid-column: 3/4; grid-row: 2/3; display: flex; flex-direction: column; gap: 12px;">

        <div class="panel">
            <div class="panel-head">BIO_MONITOR</div>
            <div class="bio-grid">
                <div class="bio-card" onclick="toggleBio(this)"><span class="bio-icon">ü¶¥</span><span class="bio-label">Posture</span></div>
                <div class="bio-card active" onclick="toggleBio(this)"><span class="bio-icon">üëÅÔ∏è</span><span class="bio-label">Vision</span></div>
                <div class="bio-card" onclick="toggleBio(this)"><span class="bio-icon">üíß</span><span class="bio-label">H2O</span></div>
            </div>
        </div>

        <div class="panel" style="padding: 12px;">
            <div class="panel-head" style="margin-bottom: 10px; border:none; padding: 0;">PRO SUITE</div>
            <button class="btn-cyber" onclick="downloadPassport()">üìÑ EXPORT PASSPORT (PDF)</button>
            <button class="btn-cyber" onclick="generateLinkedIn()">üîó SHARE SUCCESS (LINKEDIN)</button>
            <button class="btn-cyber" onclick="copyBadge()">üõ°Ô∏è COPY BADGE CODE</button>
            <button class="btn-cyber" onclick="triggerChallenge()" style="border-color: var(--neon-purple); color: var(--neon-purple);">üéôÔ∏è VOICE CHALLENGE MODE</button>
        </div>

        <div class="panel" style="flex-grow: 1; background: #000;">
            <div class="panel-head" style="border-color: var(--neon-purple); color: var(--neon-purple);">AI_MENTOR</div>
            <div id="chat-history" style="flex-grow: 1; padding: 15px; font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-dim); overflow-y: auto;">
                <div style="margin-bottom: 10px;">> System initialized.</div>
            </div>
            <input id="chat-input" type="text" placeholder="Type command..." style="width: 100%; background: #111; border: none; border-top: 1px solid var(--border); padding: 12px; color: #fff; font-family: var(--font-mono); outline: none;">
        </div>
    </aside>

    <footer style="grid-column: 2/4; display: flex; align-items: center; padding: 0 20px; font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-dim); justify-content: space-between;">
        <span>STATUS: ONLINE</span>
        <span>SYNC: GITHUB, LINKEDIN</span>
    </footer>
</div>

<script>
    // --- 0. INJECTED CONSTANTS ---
    const USER_ID = {{ user.id }};

    // --- 1. DATA SIMULATOR ---
    const mockSkills = [
        { name: "Python / FastAPI", gh_vol: 85, gap: "None", color: "#3b82f6" },
        { name: "Rust / WASM", gh_vol: 15, gap: "CRITICAL", color: "#ef4444" },
        { name: "Docker / K8s", gh_vol: 40, gap: "None", color: "#10b981" }
    ];

    function renderData() {
        const container = document.getElementById('data-container');
        container.innerHTML = '';
        mockSkills.forEach(skill => {
            const div = document.createElement('div');
            div.className = 'data-row';
            div.innerHTML = `
                <div style="width: 120px; font-weight: 600; font-size: 0.9rem; color:${skill.color}">${skill.name}</div>
                <div class="skill-bar-track"><div class="skill-bar-fill" style="width: ${skill.gh_vol}%; background: ${skill.color};"></div></div>
                <div style="width: 100px; text-align: right; font-family: var(--font-mono); font-size: 0.75rem;">
                    GH: ${skill.gh_vol}% <span class="tag ${skill.gap === 'None' ? 'tag-gh' : 'tag-warn'}">${skill.gap === 'None' ? 'OK' : 'GAP'}</span>
                </div>`;
            container.appendChild(div);
        });
    }

    // --- 2. PRO SUITE ACTIONS ---
    function showLoader(msg) {
        const loader = document.getElementById('global-loader');
        const text = document.getElementById('loader-msg');
        loader.style.display = 'flex';
        text.innerText = msg;
    }

    function hideLoader() {
        document.getElementById('global-loader').style.display = 'none';
    }

    function downloadPassport() {
        showLoader("GENERATING PDF REPORT...");
        window.location.href = '/api/export/passport';
        setTimeout(hideLoader, 3000); // Hide after download start
    }

    async function generateLinkedIn() {
        showLoader("WRITING VIRAL POST...");
        try {
            const response = await fetch('/api/generate-linkedin-post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.post_text) {
                await navigator.clipboard.writeText(data.post_text);
                showLoader("COPIED TO CLIPBOARD!");
            } else {
                alert("Error generating post");
            }
        } catch (e) {
            console.error(e);
            alert("Failed to connect to AI");
        }
        setTimeout(hideLoader, 1500);
    }

    function copyBadge() {
        const code = `[![CareerDev Badge](${window.location.origin}/api/badge/${USER_ID})]`;
        navigator.clipboard.writeText(code).then(() => {
            showLoader("COPIED TO CLIPBOARD!");
            setTimeout(hideLoader, 1000);
        });
    }

    function triggerChallenge() {
        const input = document.getElementById('chat-input');
        input.value = "Test My Weakness";
        // Simulate Enter
        addToChat("Initializing Voice Challenge Mode...");
        addToChat("[AI]: I see you lack Rust experience. Explain Ownership in 30 seconds.");
        input.value = "";
    }

    // --- 3. MATRIX EASTER EGG ---
    const konami = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
    let kIdx = 0;
    document.addEventListener('keydown', (e) => {
        if(e.key === konami[kIdx]) {
            kIdx++;
            if(kIdx === konami.length) {
                document.body.classList.toggle('theme-matrix');
                addToChat("Wake up, Neo...");
                kIdx = 0;
            }
        } else { kIdx = 0; }
    });

    // --- 4. UTILS ---
    function toggleBio(el) { el.classList.toggle('active'); }
    function addToChat(msg) {
        const chat = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.style.marginBottom = '5px'; div.innerText = `> ${msg}`;
        chat.appendChild(div);
    }

    // INIT
    document.addEventListener("DOMContentLoaded", () => {
        renderData();
        const ctx = document.getElementById('miniChart').getContext('2d');
        new Chart(ctx, { type: 'doughnut', data: { datasets: [{ data: [70, 30], backgroundColor: ['#10b981', '#ef4444'], borderWidth: 0 }] }, options: { cutout: '70%', plugins: {legend: {display:false}} } });
    });
</script>
{% endblock %}
