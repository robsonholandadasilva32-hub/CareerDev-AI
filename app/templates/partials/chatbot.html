<div id="chatbot-widget" class="chatbot-widget" aria-label="Chatbot Assistant">
    <div class="chatbot-header">
        <span class="header-title">ü§ñ CareerDev AI</span>
        <div class="header-controls">
            <!-- Voice Toggle -->
            <button id="voice-toggle" onclick="toggleVoice()" aria-label="Ativar voz" title="Ativar voz">
                üîá
            </button>
            <button onclick="toggleChat()" aria-label="Fechar chat" title="Fechar chat" class="close-btn">‚úñ</button>
        </div>
    </div>

    <div id="chatbot-messages" class="chatbot-messages" aria-live="polite" role="log">
        <div class="message bot">
            Ol√°! Sou seu assistente de carreira. Pergunte sobre Rust, Go, ou como conectar seu GitHub.
        </div>
    </div>

    <!-- Status Indicator -->
    <div id="chatbot-status" class="chatbot-status" aria-live="assertive" style="display:none;">
        <span class="pulse">‚óè</span> <span id="status-text">Desbravando...</span>
    </div>

    <div class="chatbot-input">
        <input type="text" id="chat-input" placeholder="Pergunte algo..." onkeypress="handleEnter(event)" aria-label="Digite sua mensagem">
        <button onclick="sendMessage()" aria-label="Enviar mensagem">‚û§</button>
    </div>
</div>

<!-- Chatbot Toggle Button -->
<button id="chatbot-toggle" onclick="toggleChat()" class="chatbot-toggle-btn" aria-label="Abrir assistente de carreira">
    üí¨
</button>

<style>
    .chatbot-widget {
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 320px;
        height: 450px;
        background: rgba(17, 24, 39, 0.95);
        border: 1px solid var(--primary-color);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        z-index: 9999;
        box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
        display: none; /* Hidden by default */
        backdrop-filter: blur(8px);
        font-family: 'Inter', sans-serif;
    }

    .chatbot-header {
        padding: 12px 15px;
        background: rgba(10, 15, 28, 0.9);
        border-bottom: 1px solid var(--accent-color);
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--primary-color);
        font-weight: 600;
    }

    .header-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .header-controls button {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 1.1rem;
        transition: color 0.2s;
        padding: 0;
    }

    .header-controls button:hover {
        color: var(--text-main);
    }

    .close-btn:hover {
        color: var(--error-color) !important;
    }

    .chatbot-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        scrollbar-width: thin;
        scrollbar-color: var(--accent-color) transparent;
    }

    .message {
        padding: 10px 14px;
        border-radius: 12px;
        max-width: 85%;
        font-size: 0.95rem;
        line-height: 1.4;
        word-wrap: break-word;
    }

    .message.bot {
        background: rgba(0, 243, 255, 0.08);
        color: #e0f2fe;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
        border: 1px solid rgba(0, 243, 255, 0.15);
    }

    .message.user {
        background: rgba(0, 255, 136, 0.08);
        color: #d1fae5;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
        border: 1px solid rgba(0, 255, 136, 0.15);
    }

    .chatbot-status {
        padding: 8px 15px;
        font-size: 0.85rem;
        color: var(--primary-color);
        background: rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 8px;
        font-style: italic;
    }

    .chatbot-input {
        padding: 15px;
        border-top: 1px solid var(--accent-color);
        display: flex;
        gap: 10px;
        background: rgba(10, 15, 28, 0.8);
        border-radius: 0 0 12px 12px;
    }

    .chatbot-input input {
        flex: 1;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--accent-color);
        color: white;
        padding: 10px;
        border-radius: 6px;
        font-family: inherit;
    }

    .chatbot-input input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .chatbot-input button {
        background: var(--primary-color);
        border: none;
        border-radius: 6px;
        padding: 0 15px;
        cursor: pointer;
        font-weight: bold;
        color: #000;
        transition: opacity 0.2s;
    }

    .chatbot-input button:hover {
        opacity: 0.9;
    }

    .chatbot-toggle-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 55px;
        height: 55px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), #00d2ff);
        border: none;
        font-size: 26px;
        cursor: pointer;
        z-index: 9999;
        box-shadow: 0 4px 15px rgba(0, 243, 255, 0.4);
        transition: transform 0.2s;
    }

    .chatbot-toggle-btn:hover {
        transform: scale(1.05);
    }

    .pulse {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: var(--primary-color);
        border-radius: 50%;
        animation: pulse-anim 1.5s infinite;
    }

    @keyframes pulse-anim {
        0% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.4; transform: scale(0.8); }
        100% { opacity: 1; transform: scale(1); }
    }
</style>

<script>
    let isVoiceEnabled = false;
    let currentLang = document.documentElement.lang || 'pt';

    // Translations for UI strings
    const i18n = {
        pt: { exploring: "Desbravando...", voiceOn: "Desativar voz", voiceOff: "Ativar voz" },
        en: { exploring: "Exploring...", voiceOn: "Disable voice", voiceOff: "Enable voice" },
        es: { exploring: "Explorando...", voiceOn: "Desactivar voz", voiceOff: "Activar voz" }
    };

    // Fallback to PT if lang not found
    const t = i18n[currentLang] || i18n.pt;

    function toggleChat() {
        const widget = document.getElementById('chatbot-widget');
        const btn = document.getElementById('chatbot-toggle');
        const input = document.getElementById('chat-input');

        if (widget.style.display === 'none' || widget.style.display === '') {
            widget.style.display = 'flex';
            btn.style.display = 'none';
            input.focus();
        } else {
            widget.style.display = 'none';
            btn.style.display = 'block';
        }
    }

    function toggleVoice() {
        isVoiceEnabled = !isVoiceEnabled;
        const btn = document.getElementById('voice-toggle');

        if (isVoiceEnabled) {
            btn.innerHTML = 'üîä';
            btn.setAttribute('aria-label', t.voiceOn);
            btn.title = t.voiceOn;
            // Welcome message if turning on
            speakText("Modo de voz ativado.");
        } else {
            btn.innerHTML = 'üîá';
            btn.setAttribute('aria-label', t.voiceOff);
            btn.title = t.voiceOff;
            window.speechSynthesis.cancel();
        }
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text) return;

        addMessage(text, 'user');
        input.value = '';

        // Status "Desbravando..."
        const status = document.getElementById('chatbot-status');
        const statusText = document.getElementById('status-text');

        // Update status text based on lang
        statusText.innerText = t.exploring;
        status.style.display = 'block';

        // Audio Accessibility: Speak "Exploring..." immediately if voice is on
        if (isVoiceEnabled) {
            speakText(t.exploring);
        }

        try {
            const response = await fetch('/chatbot/message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });
            const data = await response.json();

            status.style.display = 'none';
            addMessage(data.response, 'bot');

            if (isVoiceEnabled) {
                speakText(data.response);
            }

        } catch (error) {
            status.style.display = 'none';
            addMessage("Erro ao conectar com a IA.", 'bot');
            if (isVoiceEnabled) speakText("Erro de conex√£o.");
        }
    }

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        div.innerText = text;
        const container = document.getElementById('chatbot-messages');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function speakText(text) {
        if (!isVoiceEnabled) return;

        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel(); // Stop current speech

            const utterance = new SpeechSynthesisUtterance(text);

            // Map HTML lang to SpeechSynthesis lang codes
            const langMap = {
                'pt': 'pt-BR',
                'en': 'en-US',
                'es': 'es-ES'
            };

            utterance.lang = langMap[currentLang] || 'pt-BR';
            utterance.rate = 1.1; // Slightly faster for modern feel

            window.speechSynthesis.speak(utterance);
        }
    }

    // Initialize UI Text
    document.addEventListener("DOMContentLoaded", () => {
        const voiceBtn = document.getElementById('voice-toggle');
        voiceBtn.setAttribute('aria-label', t.voiceOff);
        voiceBtn.title = t.voiceOff;
    });
</script>
